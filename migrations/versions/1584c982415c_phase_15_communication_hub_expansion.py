"""Phase 15: Communication Hub Expansion

Revision ID: 1584c982415c
Revises: e6a45b8996c1
Create Date: 2025-12-06 12:15:37.873726

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '1584c982415c'
down_revision = 'e6a45b8996c1'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('blog_category',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('slug', sa.String(length=100), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('parent_id', sa.Integer(), nullable=True),
    sa.Column('display_order', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['parent_id'], ['blog_category.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('blog_category', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_blog_category_slug'), ['slug'], unique=True)

    op.create_table('category',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('slug', sa.String(length=100), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('parent_id', sa.Integer(), nullable=True),
    sa.Column('display_order', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['parent_id'], ['category.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('category', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_category_slug'), ['slug'], unique=True)

    op.create_table('cron_task',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('handler', sa.String(length=100), nullable=False),
    sa.Column('schedule', sa.String(length=50), nullable=False),
    sa.Column('payload', sa.JSON(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('last_run', sa.DateTime(), nullable=True),
    sa.Column('next_run', sa.DateTime(), nullable=True),
    sa.Column('description', sa.String(length=255), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('name')
    )
    with op.batch_alter_table('cron_task', schema=None) as batch_op:
        batch_op.create_index('idx_cron_active_next', ['is_active', 'next_run'], unique=False)

    op.create_table('email_suppression_list',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('email', sa.String(length=120), nullable=False),
    sa.Column('reason', sa.String(length=30), nullable=False),
    sa.Column('source', sa.String(length=50), nullable=True),
    sa.Column('added_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('email_suppression_list', schema=None) as batch_op:
        batch_op.create_index('idx_suppression_reason', ['reason'], unique=False)
        batch_op.create_index(batch_op.f('ix_email_suppression_list_email'), ['email'], unique=True)

    op.create_table('lead_score',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('lead_type', sa.String(length=20), nullable=False),
    sa.Column('lead_id', sa.Integer(), nullable=False),
    sa.Column('score', sa.Integer(), nullable=True),
    sa.Column('score_breakdown', sa.JSON(), nullable=True),
    sa.Column('last_calculated_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('lead_score', schema=None) as batch_op:
        batch_op.create_index('idx_lead_score_lead', ['lead_type', 'lead_id'], unique=True)
        batch_op.create_index('idx_lead_score_value', ['score'], unique=False)

    op.create_table('lead_score_rule',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('category', sa.String(length=50), nullable=False),
    sa.Column('condition_type', sa.String(length=50), nullable=False),
    sa.Column('condition_value', sa.String(length=100), nullable=True),
    sa.Column('points', sa.Integer(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('leave_type',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=50), nullable=False),
    sa.Column('display_name', sa.String(length=100), nullable=False),
    sa.Column('default_days_per_year', sa.Integer(), nullable=True),
    sa.Column('allows_carryover', sa.Boolean(), nullable=True),
    sa.Column('max_carryover_days', sa.Integer(), nullable=True),
    sa.Column('is_paid', sa.Boolean(), nullable=True),
    sa.Column('requires_approval', sa.Boolean(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('name')
    )
    op.create_table('location',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('address', sa.String(length=255), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('name')
    )
    op.create_table('pipeline_stage',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=50), nullable=False),
    sa.Column('pipeline_name', sa.String(length=50), nullable=True),
    sa.Column('order', sa.Integer(), nullable=True),
    sa.Column('color', sa.String(length=7), nullable=True),
    sa.Column('probability', sa.Integer(), nullable=True),
    sa.Column('auto_actions', sa.JSON(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('is_won_stage', sa.Boolean(), nullable=True),
    sa.Column('is_lost_stage', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('pipeline_stage', schema=None) as batch_op:
        batch_op.create_index('idx_pipeline_stage_order', ['pipeline_name', 'order'], unique=False)

    op.create_table('post_series',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('title', sa.String(length=200), nullable=False),
    sa.Column('slug', sa.String(length=200), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('post_series', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_post_series_slug'), ['slug'], unique=True)

    op.create_table('product_attribute',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('slug', sa.String(length=100), nullable=False),
    sa.Column('attribute_type', sa.String(length=50), nullable=True),
    sa.Column('position', sa.Integer(), nullable=True),
    sa.Column('is_required', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('product_attribute', schema=None) as batch_op:
        batch_op.create_index('idx_attr_position', ['position'], unique=False)
        batch_op.create_index(batch_op.f('ix_product_attribute_slug'), ['slug'], unique=True)

    op.create_table('shipping_zone',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('countries', sa.JSON(), nullable=True),
    sa.Column('states', sa.JSON(), nullable=True),
    sa.Column('zip_codes', sa.JSON(), nullable=True),
    sa.Column('is_rest_of_world', sa.Boolean(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('tag',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=50), nullable=False),
    sa.Column('slug', sa.String(length=50), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('name')
    )
    with op.batch_alter_table('tag', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_tag_slug'), ['slug'], unique=True)

    op.create_table('tax_rate',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('rate', sa.Float(), nullable=False),
    sa.Column('country', sa.String(length=2), nullable=True),
    sa.Column('state', sa.String(length=10), nullable=True),
    sa.Column('zip_code', sa.String(length=20), nullable=True),
    sa.Column('tax_type', sa.String(length=50), nullable=True),
    sa.Column('applies_to_shipping', sa.Boolean(), nullable=True),
    sa.Column('is_compound', sa.Boolean(), nullable=True),
    sa.Column('priority', sa.Integer(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('tax_rate', schema=None) as batch_op:
        batch_op.create_index('idx_tax_rate_location', ['country', 'state', 'zip_code'], unique=False)
        batch_op.create_index('idx_tax_rate_priority', ['priority'], unique=False)

    op.create_table('unsubscribed_email',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('email', sa.String(length=120), nullable=False),
    sa.Column('unsubscribed_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('email')
    )
    op.create_table('worker_heartbeat',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('worker_id', sa.String(length=50), nullable=False),
    sa.Column('last_heartbeat', sa.DateTime(), nullable=False),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('tasks_processed', sa.Integer(), nullable=True),
    sa.Column('tasks_failed', sa.Integer(), nullable=True),
    sa.Column('started_at', sa.DateTime(), nullable=True),
    sa.Column('hostname', sa.String(length=100), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('worker_id')
    )
    op.create_table('workflow',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('trigger_event', sa.String(length=100), nullable=False),
    sa.Column('description', sa.String(length=255), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('api_key',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('key_hash', sa.String(length=128), nullable=False),
    sa.Column('prefix', sa.String(length=8), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('scopes', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('last_used_at', sa.DateTime(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('key_hash')
    )
    op.create_table('audience',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('filter_rules', sa.JSON(), nullable=True),
    sa.Column('is_dynamic', sa.Boolean(), nullable=True),
    sa.Column('member_count', sa.Integer(), nullable=True),
    sa.Column('last_calculated_at', sa.DateTime(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('audience', schema=None) as batch_op:
        batch_op.create_index('idx_audience_dynamic', ['is_dynamic'], unique=False)

    op.create_table('audit_log',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('action', sa.String(length=50), nullable=False),
    sa.Column('target_type', sa.String(length=50), nullable=True),
    sa.Column('target_id', sa.Integer(), nullable=True),
    sa.Column('details', sa.JSON(), nullable=True),
    sa.Column('ip_address', sa.String(length=50), nullable=True),
    sa.Column('timestamp', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('collection',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=200), nullable=False),
    sa.Column('slug', sa.String(length=200), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('image_id', sa.Integer(), nullable=True),
    sa.Column('collection_type', sa.String(length=20), nullable=True),
    sa.Column('is_published', sa.Boolean(), nullable=True),
    sa.Column('sort_order', sa.String(length=50), nullable=True),
    sa.Column('seo_title', sa.String(length=200), nullable=True),
    sa.Column('seo_description', sa.Text(), nullable=True),
    sa.Column('show_on_homepage', sa.Boolean(), nullable=True),
    sa.Column('starts_at', sa.DateTime(), nullable=True),
    sa.Column('ends_at', sa.DateTime(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['image_id'], ['media.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('collection', schema=None) as batch_op:
        batch_op.create_index('idx_collection_homepage', ['show_on_homepage'], unique=False)
        batch_op.create_index('idx_collection_published', ['is_published'], unique=False)
        batch_op.create_index(batch_op.f('ix_collection_slug'), ['slug'], unique=True)

    op.create_table('conversion_goal',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('goal_type', sa.String(length=50), nullable=False),
    sa.Column('target_path', sa.String(length=500), nullable=True),
    sa.Column('target_value', sa.Float(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('count_once_per_session', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('conversion_goal', schema=None) as batch_op:
        batch_op.create_index('idx_goal_active', ['is_active'], unique=False)
        batch_op.create_index('idx_goal_type', ['goal_type'], unique=False)

    op.create_table('discount',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('code', sa.String(length=50), nullable=True),
    sa.Column('name', sa.String(length=200), nullable=False),
    sa.Column('discount_type', sa.String(length=50), nullable=False),
    sa.Column('value', sa.Integer(), nullable=False),
    sa.Column('minimum_order_cents', sa.Integer(), nullable=True),
    sa.Column('maximum_discount_cents', sa.Integer(), nullable=True),
    sa.Column('maximum_uses', sa.Integer(), nullable=True),
    sa.Column('used_count', sa.Integer(), nullable=True),
    sa.Column('usage_limit_per_customer', sa.Integer(), nullable=True),
    sa.Column('applies_to', sa.String(length=50), nullable=True),
    sa.Column('applies_to_ids', sa.JSON(), nullable=True),
    sa.Column('starts_at', sa.DateTime(), nullable=True),
    sa.Column('ends_at', sa.DateTime(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('is_automatic', sa.Boolean(), nullable=True),
    sa.Column('combine_with_other_discounts', sa.Boolean(), nullable=True),
    sa.Column('customer_eligibility', sa.String(length=50), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('discount', schema=None) as batch_op:
        batch_op.create_index('idx_discount_active', ['is_active', 'starts_at', 'ends_at'], unique=False)
        batch_op.create_index('idx_discount_automatic', ['is_automatic', 'is_active'], unique=False)
        batch_op.create_index('idx_discount_code', ['code'], unique=False)
        batch_op.create_index(batch_op.f('ix_discount_code'), ['code'], unique=True)

    op.create_table('drip_sequence',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('trigger_event', sa.String(length=50), nullable=False),
    sa.Column('trigger_config', sa.JSON(), nullable=True),
    sa.Column('steps_config', sa.JSON(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('drip_sequence', schema=None) as batch_op:
        batch_op.create_index('idx_drip_sequence_active', ['is_active'], unique=False)
        batch_op.create_index('idx_drip_sequence_trigger', ['trigger_event'], unique=False)

    op.create_table('email_template',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('subject', sa.String(length=200), nullable=False),
    sa.Column('body', sa.Text(), nullable=True),
    sa.Column('body_html', sa.Text(), nullable=True),
    sa.Column('body_text', sa.Text(), nullable=True),
    sa.Column('template_type', sa.String(length=50), nullable=True),
    sa.Column('category', sa.String(length=50), nullable=True),
    sa.Column('variables_schema', sa.JSON(), nullable=True),
    sa.Column('thumbnail_url', sa.String(length=500), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('email_template', schema=None) as batch_op:
        batch_op.create_index('idx_email_template_active', ['is_active'], unique=False)
        batch_op.create_index('idx_email_template_type', ['template_type'], unique=False)

    op.create_table('follow_up_reminder',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('lead_type', sa.String(length=20), nullable=False),
    sa.Column('lead_id', sa.Integer(), nullable=False),
    sa.Column('assigned_to_id', sa.Integer(), nullable=True),
    sa.Column('due_date', sa.DateTime(), nullable=False),
    sa.Column('note', sa.Text(), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('completed_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['assigned_to_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('follow_up_reminder', schema=None) as batch_op:
        batch_op.create_index('idx_followup_assigned', ['assigned_to_id', 'status'], unique=False)
        batch_op.create_index('idx_followup_due', ['due_date', 'status'], unique=False)
        batch_op.create_index('idx_followup_lead', ['lead_type', 'lead_id'], unique=False)

    op.create_table('funnel',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('lead_activity',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('lead_type', sa.String(length=20), nullable=False),
    sa.Column('lead_id', sa.Integer(), nullable=False),
    sa.Column('activity_type', sa.String(length=50), nullable=False),
    sa.Column('description', sa.String(length=255), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('old_value', sa.String(length=100), nullable=True),
    sa.Column('new_value', sa.String(length=100), nullable=True),
    sa.Column('extra_data', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('lead_activity', schema=None) as batch_op:
        batch_op.create_index('idx_lead_activity_created', ['lead_type', 'lead_id', 'created_at'], unique=False)
        batch_op.create_index('idx_lead_activity_lead', ['lead_type', 'lead_id'], unique=False)
        batch_op.create_index('idx_lead_activity_type', ['activity_type'], unique=False)

    op.create_table('lead_note',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('lead_type', sa.String(length=20), nullable=False),
    sa.Column('lead_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('is_pinned', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('lead_note', schema=None) as batch_op:
        batch_op.create_index('idx_lead_note_created', ['lead_type', 'lead_id', 'created_at'], unique=False)
        batch_op.create_index('idx_lead_note_lead', ['lead_type', 'lead_id'], unique=False)

    op.create_table('leave_balance',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('leave_type', sa.String(length=50), nullable=False),
    sa.Column('year', sa.Integer(), nullable=False),
    sa.Column('balance_days', sa.Float(), nullable=True),
    sa.Column('used_days', sa.Float(), nullable=True),
    sa.Column('carryover_days', sa.Float(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id', 'leave_type', 'year', name='uq_user_leave_year')
    )
    with op.batch_alter_table('leave_balance', schema=None) as batch_op:
        batch_op.create_index('idx_balance_user_type_year', ['user_id', 'leave_type', 'year'], unique=False)

    op.create_table('notification',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('type', sa.String(length=50), nullable=False),
    sa.Column('title', sa.String(length=200), nullable=False),
    sa.Column('body', sa.Text(), nullable=True),
    sa.Column('link', sa.String(length=500), nullable=True),
    sa.Column('is_read', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('related_type', sa.String(length=50), nullable=True),
    sa.Column('related_id', sa.Integer(), nullable=True),
    sa.Column('email_sent', sa.Boolean(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('notification', schema=None) as batch_op:
        batch_op.create_index('idx_notification_created', ['created_at'], unique=False)
        batch_op.create_index('idx_notification_type', ['type'], unique=False)
        batch_op.create_index('idx_notification_user_read', ['user_id', 'is_read'], unique=False)

    op.create_table('notification_preference',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('email_digest_enabled', sa.Boolean(), nullable=True),
    sa.Column('email_digest_frequency', sa.String(length=20), nullable=True),
    sa.Column('muted_types', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id')
    )
    op.create_table('order',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('total_amount', sa.Integer(), nullable=False),
    sa.Column('currency', sa.String(length=3), nullable=True),
    sa.Column('stripe_payment_intent_id', sa.String(length=100), nullable=True),
    sa.Column('shipping_address', sa.Text(), nullable=True),
    sa.Column('email', sa.String(length=120), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.Column('location_id', sa.Integer(), nullable=True),
    sa.Column('fulfillment_status', sa.String(length=20), nullable=True),
    sa.Column('tracking_number', sa.String(length=100), nullable=True),
    sa.Column('carrier', sa.String(length=50), nullable=True),
    sa.Column('shipped_at', sa.DateTime(), nullable=True),
    sa.Column('delivered_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['location_id'], ['location.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('product',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('price', sa.Integer(), nullable=False),
    sa.Column('currency', sa.String(length=3), nullable=True),
    sa.Column('inventory_count', sa.Integer(), nullable=True),
    sa.Column('media_id', sa.Integer(), nullable=True),
    sa.Column('location_id', sa.Integer(), nullable=True),
    sa.Column('is_digital', sa.Boolean(), nullable=True),
    sa.Column('file_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.Column('category_id', sa.Integer(), nullable=True),
    sa.Column('is_subscription', sa.Boolean(), nullable=True),
    sa.Column('stripe_price_id', sa.String(length=100), nullable=True),
    sa.ForeignKeyConstraint(['category_id'], ['category.id'], ),
    sa.ForeignKeyConstraint(['file_id'], ['media.id'], ),
    sa.ForeignKeyConstraint(['location_id'], ['location.id'], ),
    sa.ForeignKeyConstraint(['media_id'], ['media.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('product_attribute_value',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('attribute_id', sa.Integer(), nullable=False),
    sa.Column('value', sa.String(length=100), nullable=False),
    sa.Column('slug', sa.String(length=100), nullable=False),
    sa.Column('color_hex', sa.String(length=7), nullable=True),
    sa.Column('image_id', sa.Integer(), nullable=True),
    sa.Column('position', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['attribute_id'], ['product_attribute.id'], ),
    sa.ForeignKeyConstraint(['image_id'], ['media.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('attribute_id', 'slug', name='uq_attr_value_slug')
    )
    with op.batch_alter_table('product_attribute_value', schema=None) as batch_op:
        batch_op.create_index('idx_attr_value_attr', ['attribute_id', 'position'], unique=False)

    op.create_table('product_bundle',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=200), nullable=False),
    sa.Column('slug', sa.String(length=200), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('bundle_price_cents', sa.Integer(), nullable=True),
    sa.Column('discount_type', sa.String(length=20), nullable=True),
    sa.Column('discount_value', sa.Integer(), nullable=True),
    sa.Column('image_id', sa.Integer(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('requires_all_items', sa.Boolean(), nullable=True),
    sa.Column('min_items', sa.Integer(), nullable=True),
    sa.Column('max_items', sa.Integer(), nullable=True),
    sa.Column('starts_at', sa.DateTime(), nullable=True),
    sa.Column('ends_at', sa.DateTime(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['image_id'], ['media.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('product_bundle', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_product_bundle_slug'), ['slug'], unique=True)

    op.create_table('push_subscription',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('endpoint', sa.Text(), nullable=False),
    sa.Column('p256dh_key', sa.String(length=200), nullable=False),
    sa.Column('auth_key', sa.String(length=50), nullable=False),
    sa.Column('user_agent', sa.String(length=500), nullable=True),
    sa.Column('device_name', sa.String(length=100), nullable=True),
    sa.Column('categories', sa.JSON(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('subscribed_at', sa.DateTime(), nullable=True),
    sa.Column('last_used_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('push_subscription', schema=None) as batch_op:
        batch_op.create_index('idx_push_sub_active', ['is_active'], unique=False)
        batch_op.create_index('idx_push_sub_user', ['user_id'], unique=False)

    op.create_table('saved_report',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('report_type', sa.String(length=50), nullable=False),
    sa.Column('config_json', sa.JSON(), nullable=True),
    sa.Column('schedule_cron', sa.String(length=50), nullable=True),
    sa.Column('last_run_at', sa.DateTime(), nullable=True),
    sa.Column('next_run_at', sa.DateTime(), nullable=True),
    sa.Column('is_public', sa.Boolean(), nullable=True),
    sa.Column('is_archived', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('saved_report', schema=None) as batch_op:
        batch_op.create_index('idx_report_created_by', ['created_by_id'], unique=False)
        batch_op.create_index('idx_report_type', ['report_type'], unique=False)

    op.create_table('shipping_rate',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('zone_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('rate_type', sa.String(length=50), nullable=True),
    sa.Column('price_cents', sa.Integer(), nullable=True),
    sa.Column('price_per_kg_cents', sa.Integer(), nullable=True),
    sa.Column('min_weight_grams', sa.Integer(), nullable=True),
    sa.Column('max_weight_grams', sa.Integer(), nullable=True),
    sa.Column('min_order_cents', sa.Integer(), nullable=True),
    sa.Column('max_order_cents', sa.Integer(), nullable=True),
    sa.Column('free_shipping_threshold_cents', sa.Integer(), nullable=True),
    sa.Column('estimated_days_min', sa.Integer(), nullable=True),
    sa.Column('estimated_days_max', sa.Integer(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.ForeignKeyConstraint(['zone_id'], ['shipping_zone.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('shipping_rate', schema=None) as batch_op:
        batch_op.create_index('idx_shipping_rate_zone', ['zone_id'], unique=False)

    op.create_table('sms_consent',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('phone_number', sa.String(length=20), nullable=False),
    sa.Column('consented', sa.Boolean(), nullable=True),
    sa.Column('consented_at', sa.DateTime(), nullable=True),
    sa.Column('revoked_at', sa.DateTime(), nullable=True),
    sa.Column('consent_source', sa.String(length=100), nullable=True),
    sa.Column('consent_text', sa.Text(), nullable=True),
    sa.Column('ip_address', sa.String(length=45), nullable=True),
    sa.Column('categories', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('sms_consent', schema=None) as batch_op:
        batch_op.create_index('idx_sms_consent_phone', ['phone_number'], unique=False)
        batch_op.create_index('idx_sms_consent_user', ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_sms_consent_phone_number'), ['phone_number'], unique=False)

    op.create_table('sms_template',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('body', sa.String(length=1600), nullable=False),
    sa.Column('variables_schema', sa.JSON(), nullable=True),
    sa.Column('character_count', sa.Integer(), nullable=True),
    sa.Column('segment_count', sa.Integer(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('time_entry',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('clock_in', sa.DateTime(), nullable=False),
    sa.Column('clock_out', sa.DateTime(), nullable=True),
    sa.Column('duration_minutes', sa.Integer(), nullable=True),
    sa.Column('date', sa.Date(), nullable=False),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('time_entry', schema=None) as batch_op:
        batch_op.create_index('idx_time_user_date', ['user_id', 'date'], unique=False)

    op.create_table('user_cart',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('cart_data', sa.JSON(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id')
    )
    op.create_table('visitor_session',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('session_token', sa.String(length=64), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('ip_hash', sa.String(length=64), nullable=True),
    sa.Column('entry_page', sa.String(length=500), nullable=True),
    sa.Column('exit_page', sa.String(length=500), nullable=True),
    sa.Column('pages_viewed', sa.Integer(), nullable=True),
    sa.Column('duration_seconds', sa.Integer(), nullable=True),
    sa.Column('bounce', sa.Boolean(), nullable=True),
    sa.Column('referrer', sa.String(length=500), nullable=True),
    sa.Column('utm_source', sa.String(length=100), nullable=True),
    sa.Column('utm_medium', sa.String(length=100), nullable=True),
    sa.Column('utm_campaign', sa.String(length=100), nullable=True),
    sa.Column('device_type', sa.String(length=20), nullable=True),
    sa.Column('browser', sa.String(length=50), nullable=True),
    sa.Column('os', sa.String(length=50), nullable=True),
    sa.Column('country', sa.String(length=100), nullable=True),
    sa.Column('started_at', sa.DateTime(), nullable=True),
    sa.Column('ended_at', sa.DateTime(), nullable=True),
    sa.Column('last_activity_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('visitor_session', schema=None) as batch_op:
        batch_op.create_index('idx_session_started', ['started_at'], unique=False)
        batch_op.create_index('idx_session_user', ['user_id'], unique=False)
        batch_op.create_index('idx_session_utm', ['utm_source', 'utm_medium'], unique=False)
        batch_op.create_index(batch_op.f('ix_visitor_session_session_token'), ['session_token'], unique=True)
        batch_op.create_index(batch_op.f('ix_visitor_session_started_at'), ['started_at'], unique=False)

    op.create_table('webhook',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('url', sa.String(length=500), nullable=False),
    sa.Column('secret', sa.String(length=64), nullable=True),
    sa.Column('events', sa.JSON(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('last_triggered_at', sa.DateTime(), nullable=True),
    sa.Column('last_status_code', sa.Integer(), nullable=True),
    sa.Column('failure_count', sa.Integer(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('webhook', schema=None) as batch_op:
        batch_op.create_index('idx_webhook_active', ['is_active'], unique=False)

    op.create_table('workflow_step',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('workflow_id', sa.Integer(), nullable=False),
    sa.Column('action_type', sa.String(length=50), nullable=False),
    sa.Column('config', sa.JSON(), nullable=True),
    sa.Column('order', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['workflow_id'], ['workflow.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('audience_member',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('audience_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('email', sa.String(length=120), nullable=False),
    sa.Column('added_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['audience_id'], ['audience.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('audience_id', 'email', name='uq_audience_member_email')
    )
    with op.batch_alter_table('audience_member', schema=None) as batch_op:
        batch_op.create_index('idx_audience_member_audience', ['audience_id'], unique=False)

    op.create_table('availability',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('estimator_id', sa.Integer(), nullable=False),
    sa.Column('day_of_week', sa.Integer(), nullable=False),
    sa.Column('start_time', sa.Time(), nullable=False),
    sa.Column('end_time', sa.Time(), nullable=False),
    sa.Column('is_recurring', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['estimator_id'], ['estimator.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('availability', schema=None) as batch_op:
        batch_op.create_index('idx_availability_estimator_day', ['estimator_id', 'day_of_week'], unique=False)

    op.create_table('availability_exception',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('estimator_id', sa.Integer(), nullable=False),
    sa.Column('date', sa.Date(), nullable=False),
    sa.Column('is_blocked', sa.Boolean(), nullable=True),
    sa.Column('custom_start_time', sa.Time(), nullable=True),
    sa.Column('custom_end_time', sa.Time(), nullable=True),
    sa.Column('reason', sa.String(length=100), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['estimator_id'], ['estimator.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('availability_exception', schema=None) as batch_op:
        batch_op.create_index('idx_exception_estimator_date', ['estimator_id', 'date'], unique=False)

    op.create_table('channel_members',
    sa.Column('channel_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['channel_id'], ['channel.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('channel_id', 'user_id')
    )
    op.create_table('collection_product',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('collection_id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('position', sa.Integer(), nullable=True),
    sa.Column('added_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['collection_id'], ['collection.id'], ),
    sa.ForeignKeyConstraint(['product_id'], ['product.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('collection_id', 'product_id', name='uq_collection_product')
    )
    with op.batch_alter_table('collection_product', schema=None) as batch_op:
        batch_op.create_index('idx_collection_product_pos', ['collection_id', 'position'], unique=False)

    op.create_table('collection_rule',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('collection_id', sa.Integer(), nullable=False),
    sa.Column('field', sa.String(length=50), nullable=False),
    sa.Column('condition', sa.String(length=50), nullable=False),
    sa.Column('value', sa.String(length=200), nullable=False),
    sa.ForeignKeyConstraint(['collection_id'], ['collection.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('collection_rule', schema=None) as batch_op:
        batch_op.create_index('idx_collection_rule', ['collection_id'], unique=False)

    op.create_table('comment',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('post_id', sa.Integer(), nullable=False),
    sa.Column('parent_id', sa.Integer(), nullable=True),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('author_name', sa.String(length=100), nullable=True),
    sa.Column('author_email', sa.String(length=120), nullable=True),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('ip_hash', sa.String(length=64), nullable=True),
    sa.ForeignKeyConstraint(['parent_id'], ['comment.id'], ),
    sa.ForeignKeyConstraint(['post_id'], ['post.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('comment', schema=None) as batch_op:
        batch_op.create_index('idx_comment_post_status', ['post_id', 'status'], unique=False)
        batch_op.create_index('idx_comment_status', ['status'], unique=False)

    op.create_table('conversion',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('goal_id', sa.Integer(), nullable=False),
    sa.Column('session_id', sa.String(length=64), nullable=True),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('value', sa.Float(), nullable=True),
    sa.Column('source', sa.String(length=100), nullable=True),
    sa.Column('medium', sa.String(length=100), nullable=True),
    sa.Column('campaign', sa.String(length=100), nullable=True),
    sa.Column('first_touch_source', sa.String(length=100), nullable=True),
    sa.Column('last_touch_source', sa.String(length=100), nullable=True),
    sa.Column('timestamp', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['goal_id'], ['conversion_goal.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('conversion', schema=None) as batch_op:
        batch_op.create_index('idx_conversion_goal_time', ['goal_id', 'timestamp'], unique=False)
        batch_op.create_index('idx_conversion_session', ['session_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_conversion_session_id'), ['session_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_conversion_timestamp'), ['timestamp'], unique=False)

    op.create_table('discount_rule',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('discount_id', sa.Integer(), nullable=False),
    sa.Column('rule_type', sa.String(length=50), nullable=False),
    sa.Column('condition', sa.String(length=50), nullable=False),
    sa.Column('value', sa.String(length=200), nullable=False),
    sa.ForeignKeyConstraint(['discount_id'], ['discount.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('discount_rule', schema=None) as batch_op:
        batch_op.create_index('idx_discount_rule', ['discount_id'], unique=False)

    op.create_table('discount_usage',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('discount_id', sa.Integer(), nullable=False),
    sa.Column('order_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('amount_saved_cents', sa.Integer(), nullable=False),
    sa.Column('used_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['discount_id'], ['discount.id'], ),
    sa.ForeignKeyConstraint(['order_id'], ['order.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('discount_usage', schema=None) as batch_op:
        batch_op.create_index('idx_discount_usage_order', ['order_id'], unique=False)
        batch_op.create_index('idx_discount_usage_user', ['user_id'], unique=False)

    op.create_table('document_share',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('document_id', sa.Integer(), nullable=False),
    sa.Column('shared_with_user_id', sa.Integer(), nullable=True),
    sa.Column('shared_with_role', sa.String(length=50), nullable=True),
    sa.Column('permissions', sa.String(length=20), nullable=True),
    sa.Column('shared_by_id', sa.Integer(), nullable=False),
    sa.Column('shared_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['document_id'], ['encrypted_document.id'], ),
    sa.ForeignKeyConstraint(['shared_by_id'], ['user.id'], ),
    sa.ForeignKeyConstraint(['shared_with_user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('document_share', schema=None) as batch_op:
        batch_op.create_index('idx_share_doc', ['document_id'], unique=False)
        batch_op.create_index('idx_share_role', ['shared_with_role'], unique=False)
        batch_op.create_index('idx_share_user', ['shared_with_user_id'], unique=False)

    op.create_table('email_campaign',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('template_id', sa.Integer(), nullable=False),
    sa.Column('audience_id', sa.Integer(), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('scheduled_at', sa.DateTime(), nullable=True),
    sa.Column('sent_at', sa.DateTime(), nullable=True),
    sa.Column('completed_at', sa.DateTime(), nullable=True),
    sa.Column('subject_line_a', sa.String(length=200), nullable=True),
    sa.Column('subject_line_b', sa.String(length=200), nullable=True),
    sa.Column('ab_test_percentage', sa.Integer(), nullable=True),
    sa.Column('sent_count', sa.Integer(), nullable=True),
    sa.Column('delivered_count', sa.Integer(), nullable=True),
    sa.Column('open_count', sa.Integer(), nullable=True),
    sa.Column('unique_open_count', sa.Integer(), nullable=True),
    sa.Column('click_count', sa.Integer(), nullable=True),
    sa.Column('unique_click_count', sa.Integer(), nullable=True),
    sa.Column('unsubscribe_count', sa.Integer(), nullable=True),
    sa.Column('bounce_count', sa.Integer(), nullable=True),
    sa.Column('complaint_count', sa.Integer(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['audience_id'], ['audience.id'], ),
    sa.ForeignKeyConstraint(['created_by_id'], ['user.id'], ),
    sa.ForeignKeyConstraint(['template_id'], ['email_template.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('email_campaign', schema=None) as batch_op:
        batch_op.create_index('idx_campaign_scheduled', ['scheduled_at'], unique=False)
        batch_op.create_index('idx_campaign_status', ['status'], unique=False)

    op.create_table('funnel_step',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('funnel_id', sa.Integer(), nullable=False),
    sa.Column('goal_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('step_order', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['funnel_id'], ['funnel.id'], ),
    sa.ForeignKeyConstraint(['goal_id'], ['conversion_goal.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('funnel_id', 'step_order', name='uq_funnel_step_order')
    )
    with op.batch_alter_table('funnel_step', schema=None) as batch_op:
        batch_op.create_index('idx_funnelstep_funnel_order', ['funnel_id', 'step_order'], unique=False)

    op.create_table('gift_card',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('code', sa.String(length=20), nullable=False),
    sa.Column('initial_balance_cents', sa.Integer(), nullable=False),
    sa.Column('current_balance_cents', sa.Integer(), nullable=False),
    sa.Column('currency', sa.String(length=3), nullable=True),
    sa.Column('expires_at', sa.DateTime(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=True),
    sa.Column('recipient_email', sa.String(length=120), nullable=True),
    sa.Column('recipient_name', sa.String(length=100), nullable=True),
    sa.Column('sender_name', sa.String(length=100), nullable=True),
    sa.Column('message', sa.Text(), nullable=True),
    sa.Column('purchased_order_id', sa.Integer(), nullable=True),
    sa.Column('delivered_at', sa.DateTime(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['user.id'], ),
    sa.ForeignKeyConstraint(['purchased_order_id'], ['order.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('gift_card', schema=None) as batch_op:
        batch_op.create_index('idx_gift_card_active', ['is_active'], unique=False)
        batch_op.create_index('idx_gift_card_code', ['code'], unique=False)
        batch_op.create_index(batch_op.f('ix_gift_card_code'), ['code'], unique=True)

    op.create_table('inventory_lock',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('quantity', sa.Integer(), nullable=False),
    sa.Column('session_id', sa.String(length=64), nullable=False),
    sa.Column('order_id', sa.Integer(), nullable=True),
    sa.Column('expires_at', sa.DateTime(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['order_id'], ['order.id'], ),
    sa.ForeignKeyConstraint(['product_id'], ['product.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('order_item',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('order_id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('quantity', sa.Integer(), nullable=True),
    sa.Column('price_at_purchase', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['order_id'], ['order.id'], ),
    sa.ForeignKeyConstraint(['product_id'], ['product.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('page_custom_field',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('page_id', sa.Integer(), nullable=False),
    sa.Column('field_name', sa.String(length=100), nullable=False),
    sa.Column('field_type', sa.String(length=20), nullable=True),
    sa.Column('field_value', sa.Text(), nullable=True),
    sa.Column('display_order', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['page_id'], ['page.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('page_id', 'field_name', name='uq_page_field')
    )
    with op.batch_alter_table('page_custom_field', schema=None) as batch_op:
        batch_op.create_index('idx_pcf_page', ['page_id'], unique=False)

    op.create_table('page_revision',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('page_id', sa.Integer(), nullable=False),
    sa.Column('title', sa.String(length=200), nullable=False),
    sa.Column('html_content', sa.Text(), nullable=True),
    sa.Column('meta_description', sa.String(length=300), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('revision_note', sa.String(length=255), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['page_id'], ['page.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('page_revision', schema=None) as batch_op:
        batch_op.create_index('idx_page_revision_page_created', ['page_id', 'created_at'], unique=False)

    op.create_table('post_authors',
    sa.Column('post_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['post_id'], ['post.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('post_id', 'user_id')
    )
    op.create_table('post_image',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('post_id', sa.Integer(), nullable=False),
    sa.Column('media_id', sa.Integer(), nullable=False),
    sa.Column('caption', sa.String(length=255), nullable=True),
    sa.Column('alt_text', sa.String(length=255), nullable=True),
    sa.Column('display_order', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['media_id'], ['media.id'], ),
    sa.ForeignKeyConstraint(['post_id'], ['post.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('post_revision',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('post_id', sa.Integer(), nullable=False),
    sa.Column('title', sa.String(length=200), nullable=False),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('revision_note', sa.String(length=255), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['post_id'], ['post.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('post_revision', schema=None) as batch_op:
        batch_op.create_index('idx_revision_post_created', ['post_id', 'created_at'], unique=False)

    op.create_table('post_tags',
    sa.Column('post_id', sa.Integer(), nullable=False),
    sa.Column('tag_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['post_id'], ['post.id'], ),
    sa.ForeignKeyConstraint(['tag_id'], ['tag.id'], ),
    sa.PrimaryKeyConstraint('post_id', 'tag_id')
    )
    op.create_table('product_attribute_assignment',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('attribute_id', sa.Integer(), nullable=False),
    sa.Column('position', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['attribute_id'], ['product_attribute.id'], ),
    sa.ForeignKeyConstraint(['product_id'], ['product.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('product_id', 'attribute_id', name='uq_product_attr')
    )
    op.create_table('product_variant',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('sku', sa.String(length=50), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('price_adjustment', sa.Integer(), nullable=True),
    sa.Column('inventory_count', sa.Integer(), nullable=True),
    sa.Column('attributes', sa.JSON(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['product_id'], ['product.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('product_variant', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_product_variant_sku'), ['sku'], unique=True)

    op.create_table('recently_viewed',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('session_id', sa.String(length=64), nullable=True),
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('viewed_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['product_id'], ['product.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('recently_viewed', schema=None) as batch_op:
        batch_op.create_index('idx_recently_viewed_session', ['session_id', 'viewed_at'], unique=False)
        batch_op.create_index('idx_recently_viewed_user', ['user_id', 'viewed_at'], unique=False)

    op.create_table('related_product',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('related_product_id', sa.Integer(), nullable=False),
    sa.Column('relation_type', sa.String(length=50), nullable=False),
    sa.Column('position', sa.Integer(), nullable=True),
    sa.Column('is_auto_generated', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['product_id'], ['product.id'], ),
    sa.ForeignKeyConstraint(['related_product_id'], ['product.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('product_id', 'related_product_id', 'relation_type', name='uq_related_product')
    )
    with op.batch_alter_table('related_product', schema=None) as batch_op:
        batch_op.create_index('idx_related_product', ['product_id', 'relation_type'], unique=False)

    op.create_table('report_export',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('report_id', sa.Integer(), nullable=True),
    sa.Column('report_type', sa.String(length=50), nullable=False),
    sa.Column('format', sa.String(length=10), nullable=False),
    sa.Column('file_path', sa.String(length=500), nullable=True),
    sa.Column('file_size_bytes', sa.Integer(), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('download_count', sa.Integer(), nullable=True),
    sa.Column('expires_at', sa.DateTime(), nullable=True),
    sa.Column('generated_at', sa.DateTime(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('generated_by_id', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['generated_by_id'], ['user.id'], ),
    sa.ForeignKeyConstraint(['report_id'], ['saved_report.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('report_export', schema=None) as batch_op:
        batch_op.create_index('idx_export_created', ['created_at'], unique=False)
        batch_op.create_index('idx_export_status', ['status'], unique=False)

    op.create_table('sequence_enrollment',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('sequence_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('email', sa.String(length=120), nullable=False),
    sa.Column('current_step', sa.Integer(), nullable=True),
    sa.Column('next_step_at', sa.DateTime(), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('enrolled_at', sa.DateTime(), nullable=True),
    sa.Column('completed_at', sa.DateTime(), nullable=True),
    sa.Column('context_data', sa.JSON(), nullable=True),
    sa.ForeignKeyConstraint(['sequence_id'], ['drip_sequence.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('sequence_enrollment', schema=None) as batch_op:
        batch_op.create_index('idx_enrollment_next_step', ['next_step_at'], unique=False)
        batch_op.create_index('idx_enrollment_sequence', ['sequence_id'], unique=False)
        batch_op.create_index('idx_enrollment_status', ['status'], unique=False)

    op.create_table('subscription',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('stripe_subscription_id', sa.String(length=100), nullable=False),
    sa.Column('stripe_customer_id', sa.String(length=100), nullable=False),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('current_period_start', sa.DateTime(), nullable=True),
    sa.Column('current_period_end', sa.DateTime(), nullable=True),
    sa.Column('cancel_at_period_end', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['product_id'], ['product.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('subscription', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_subscription_stripe_subscription_id'), ['stripe_subscription_id'], unique=True)

    op.create_table('bundle_item',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('bundle_id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('variant_id', sa.Integer(), nullable=True),
    sa.Column('quantity', sa.Integer(), nullable=True),
    sa.Column('is_optional', sa.Boolean(), nullable=True),
    sa.Column('is_default_selected', sa.Boolean(), nullable=True),
    sa.ForeignKeyConstraint(['bundle_id'], ['product_bundle.id'], ),
    sa.ForeignKeyConstraint(['product_id'], ['product.id'], ),
    sa.ForeignKeyConstraint(['variant_id'], ['product_variant.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('bundle_item', schema=None) as batch_op:
        batch_op.create_index('idx_bundle_item', ['bundle_id'], unique=False)

    op.create_table('channel_member',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('channel_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('last_read_message_id', sa.Integer(), nullable=True),
    sa.Column('last_read_at', sa.DateTime(), nullable=True),
    sa.Column('joined_at', sa.DateTime(), nullable=True),
    sa.Column('is_muted', sa.Boolean(), nullable=True),
    sa.ForeignKeyConstraint(['channel_id'], ['channel.id'], ),
    sa.ForeignKeyConstraint(['last_read_message_id'], ['message.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('channel_id', 'user_id', name='uq_channel_member')
    )
    with op.batch_alter_table('channel_member', schema=None) as batch_op:
        batch_op.create_index('idx_cm_channel', ['channel_id'], unique=False)
        batch_op.create_index('idx_cm_user', ['user_id'], unique=False)

    op.create_table('download_token',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('token', sa.String(length=64), nullable=False),
    sa.Column('order_item_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('max_downloads', sa.Integer(), nullable=True),
    sa.Column('download_count', sa.Integer(), nullable=True),
    sa.Column('expires_at', sa.DateTime(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['order_item_id'], ['order_item.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('download_token', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_download_token_token'), ['token'], unique=True)

    op.create_table('email_send',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('campaign_id', sa.Integer(), nullable=True),
    sa.Column('template_id', sa.Integer(), nullable=True),
    sa.Column('recipient_email', sa.String(length=120), nullable=False),
    sa.Column('recipient_id', sa.Integer(), nullable=True),
    sa.Column('tracking_token', sa.String(length=64), nullable=False),
    sa.Column('variant', sa.String(length=1), nullable=True),
    sa.Column('sent_at', sa.DateTime(), nullable=True),
    sa.Column('delivered_at', sa.DateTime(), nullable=True),
    sa.Column('first_opened_at', sa.DateTime(), nullable=True),
    sa.Column('last_opened_at', sa.DateTime(), nullable=True),
    sa.Column('first_clicked_at', sa.DateTime(), nullable=True),
    sa.Column('open_count', sa.Integer(), nullable=True),
    sa.Column('click_count', sa.Integer(), nullable=True),
    sa.Column('bounced', sa.Boolean(), nullable=True),
    sa.Column('bounce_type', sa.String(length=20), nullable=True),
    sa.Column('bounce_reason', sa.Text(), nullable=True),
    sa.Column('unsubscribed', sa.Boolean(), nullable=True),
    sa.Column('unsubscribed_at', sa.DateTime(), nullable=True),
    sa.Column('complained', sa.Boolean(), nullable=True),
    sa.ForeignKeyConstraint(['campaign_id'], ['email_campaign.id'], ),
    sa.ForeignKeyConstraint(['recipient_id'], ['user.id'], ),
    sa.ForeignKeyConstraint(['template_id'], ['email_template.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('email_send', schema=None) as batch_op:
        batch_op.create_index('idx_email_send_campaign', ['campaign_id'], unique=False)
        batch_op.create_index('idx_email_send_recipient', ['recipient_email'], unique=False)
        batch_op.create_index('idx_email_send_sent', ['sent_at'], unique=False)
        batch_op.create_index('idx_email_send_token', ['tracking_token'], unique=False)
        batch_op.create_index(batch_op.f('ix_email_send_tracking_token'), ['tracking_token'], unique=True)

    op.create_table('gift_card_transaction',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('gift_card_id', sa.Integer(), nullable=False),
    sa.Column('order_id', sa.Integer(), nullable=True),
    sa.Column('amount_cents', sa.Integer(), nullable=False),
    sa.Column('transaction_type', sa.String(length=50), nullable=False),
    sa.Column('note', sa.Text(), nullable=True),
    sa.Column('created_by_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['created_by_id'], ['user.id'], ),
    sa.ForeignKeyConstraint(['gift_card_id'], ['gift_card.id'], ),
    sa.ForeignKeyConstraint(['order_id'], ['order.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('gift_card_transaction', schema=None) as batch_op:
        batch_op.create_index('idx_gift_card_tx', ['gift_card_id', 'created_at'], unique=False)

    op.create_table('message_reaction',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('message_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('emoji', sa.String(length=20), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['message_id'], ['message.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('message_id', 'user_id', 'emoji', name='uq_message_reaction')
    )
    with op.batch_alter_table('message_reaction', schema=None) as batch_op:
        batch_op.create_index('idx_reaction_message', ['message_id'], unique=False)

    op.create_table('product_image',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('media_id', sa.Integer(), nullable=False),
    sa.Column('alt_text', sa.String(length=255), nullable=True),
    sa.Column('position', sa.Integer(), nullable=True),
    sa.Column('is_primary', sa.Boolean(), nullable=True),
    sa.Column('variant_id', sa.Integer(), nullable=True),
    sa.Column('image_type', sa.String(length=50), nullable=True),
    sa.ForeignKeyConstraint(['media_id'], ['media.id'], ),
    sa.ForeignKeyConstraint(['product_id'], ['product.id'], ),
    sa.ForeignKeyConstraint(['variant_id'], ['product_variant.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('product_image', schema=None) as batch_op:
        batch_op.create_index('idx_product_image', ['product_id', 'position'], unique=False)
        batch_op.create_index('idx_product_image_primary', ['product_id', 'is_primary'], unique=False)

    op.create_table('reschedule_request',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('appointment_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('proposed_datetime', sa.DateTime(), nullable=False),
    sa.Column('reason', sa.Text(), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('admin_notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['appointment_id'], ['appointment.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('reschedule_request', schema=None) as batch_op:
        batch_op.create_index('idx_reschedule_status', ['status'], unique=False)

    op.create_table('wishlist',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('variant_id', sa.Integer(), nullable=True),
    sa.Column('added_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['product_id'], ['product.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.ForeignKeyConstraint(['variant_id'], ['product_variant.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id', 'product_id', 'variant_id', name='uq_wishlist_item')
    )
    with op.batch_alter_table('wishlist', schema=None) as batch_op:
        batch_op.create_index('idx_wishlist_user', ['user_id'], unique=False)

    op.create_table('download_log',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('download_token_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('ip_hash', sa.String(length=64), nullable=True),
    sa.Column('user_agent', sa.String(length=200), nullable=True),
    sa.Column('downloaded_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['download_token_id'], ['download_token.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('email_click_track',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('email_send_id', sa.Integer(), nullable=False),
    sa.Column('original_url', sa.String(length=2000), nullable=False),
    sa.Column('clicked_at', sa.DateTime(), nullable=True),
    sa.Column('user_agent', sa.String(length=500), nullable=True),
    sa.Column('ip_hash', sa.String(length=64), nullable=True),
    sa.ForeignKeyConstraint(['email_send_id'], ['email_send.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('email_click_track', schema=None) as batch_op:
        batch_op.create_index('idx_click_track_send', ['email_send_id'], unique=False)

    with op.batch_alter_table('appointment', schema=None) as batch_op:
        batch_op.add_column(sa.Column('location_id', sa.Integer(), nullable=True))
        batch_op.add_column(sa.Column('staff_notes', sa.Text(), nullable=True))
        batch_op.add_column(sa.Column('checked_in_at', sa.DateTime(), nullable=True))
        batch_op.add_column(sa.Column('checked_out_at', sa.DateTime(), nullable=True))
        batch_op.add_column(sa.Column('is_recurring', sa.Boolean(), nullable=True))
        batch_op.add_column(sa.Column('recurring_parent_id', sa.Integer(), nullable=True))
        batch_op.create_foreign_key(None, 'appointment', ['recurring_parent_id'], ['id'])
        batch_op.create_foreign_key(None, 'location', ['location_id'], ['id'])

    with op.batch_alter_table('channel', schema=None) as batch_op:
        batch_op.add_column(sa.Column('is_archived', sa.Boolean(), nullable=True))
        batch_op.add_column(sa.Column('is_direct', sa.Boolean(), nullable=True))
        batch_op.add_column(sa.Column('created_by_id', sa.Integer(), nullable=True))
        batch_op.add_column(sa.Column('description', sa.String(length=255), nullable=True))
        batch_op.create_index('idx_channel_archived', ['is_archived'], unique=False)
        batch_op.create_index('idx_channel_type', ['type'], unique=False)
        batch_op.create_foreign_key(None, 'user', ['created_by_id'], ['id'])

    with op.batch_alter_table('contact_form_submission', schema=None) as batch_op:
        batch_op.add_column(sa.Column('location_id', sa.Integer(), nullable=True))
        batch_op.add_column(sa.Column('source', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('assigned_to_id', sa.Integer(), nullable=True))
        batch_op.add_column(sa.Column('custom_fields', sa.JSON(), nullable=True))
        batch_op.create_foreign_key(None, 'user', ['assigned_to_id'], ['id'])
        batch_op.create_foreign_key(None, 'location', ['location_id'], ['id'])

    with op.batch_alter_table('encrypted_document', schema=None) as batch_op:
        batch_op.add_column(sa.Column('category', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('expires_at', sa.Date(), nullable=True))
        batch_op.add_column(sa.Column('requires_signature', sa.Boolean(), nullable=True))
        batch_op.add_column(sa.Column('signed_by_id', sa.Integer(), nullable=True))
        batch_op.add_column(sa.Column('signed_at', sa.DateTime(), nullable=True))
        batch_op.add_column(sa.Column('mimetype', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('original_filename', sa.String(length=255), nullable=True))
        batch_op.create_index('idx_doc_expiry', ['expires_at'], unique=False)
        batch_op.create_index('idx_doc_user_category', ['user_id', 'category'], unique=False)
        batch_op.create_foreign_key(None, 'user', ['signed_by_id'], ['id'])

    with op.batch_alter_table('estimator', schema=None) as batch_op:
        batch_op.add_column(sa.Column('user_id', sa.Integer(), nullable=True))
        batch_op.create_foreign_key(None, 'user', ['user_id'], ['id'])

    with op.batch_alter_table('leave_request', schema=None) as batch_op:
        batch_op.add_column(sa.Column('leave_type', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('approved_by_id', sa.Integer(), nullable=True))
        batch_op.add_column(sa.Column('approved_at', sa.DateTime(), nullable=True))
        batch_op.add_column(sa.Column('admin_notes', sa.Text(), nullable=True))
        batch_op.create_index('idx_leave_dates', ['start_date', 'end_date'], unique=False)
        batch_op.create_index('idx_leave_user_status', ['user_id', 'status'], unique=False)
        batch_op.create_foreign_key(None, 'user', ['approved_by_id'], ['id'])

    with op.batch_alter_table('message', schema=None) as batch_op:
        batch_op.add_column(sa.Column('parent_id', sa.Integer(), nullable=True))
        batch_op.create_index('idx_message_channel_created', ['channel_id', 'created_at'], unique=False)
        batch_op.create_foreign_key(None, 'message', ['parent_id'], ['id'])

    with op.batch_alter_table('page', schema=None) as batch_op:
        batch_op.add_column(sa.Column('status', sa.String(length=20), nullable=True))
        batch_op.add_column(sa.Column('canonical_url', sa.String(length=500), nullable=True))
        batch_op.add_column(sa.Column('schema_type', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('author_id', sa.Integer(), nullable=True))
        batch_op.create_index('idx_page_status', ['status'], unique=False)
        batch_op.create_foreign_key(None, 'user', ['author_id'], ['id'])

    with op.batch_alter_table('page_view', schema=None) as batch_op:
        batch_op.add_column(sa.Column('session_id', sa.String(length=64), nullable=True))
        batch_op.add_column(sa.Column('user_id', sa.Integer(), nullable=True))
        batch_op.add_column(sa.Column('load_time_ms', sa.Integer(), nullable=True))
        batch_op.add_column(sa.Column('utm_source', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('utm_medium', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('utm_campaign', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('utm_term', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('utm_content', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('device_type', sa.String(length=20), nullable=True))
        batch_op.add_column(sa.Column('browser', sa.String(length=50), nullable=True))
        batch_op.add_column(sa.Column('os', sa.String(length=50), nullable=True))
        batch_op.alter_column('user_agent',
               existing_type=sa.VARCHAR(length=200),
               type_=sa.String(length=500),
               existing_nullable=True)
        batch_op.create_index('idx_pageview_session', ['session_id'], unique=False)
        batch_op.create_index('idx_pageview_timestamp', ['timestamp'], unique=False)
        batch_op.create_index('idx_pageview_url', ['url'], unique=False)
        batch_op.create_index('idx_pageview_utm', ['utm_source', 'utm_medium', 'utm_campaign'], unique=False)
        batch_op.create_index(batch_op.f('ix_page_view_session_id'), ['session_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_page_view_timestamp'), ['timestamp'], unique=False)
        batch_op.create_foreign_key(None, 'user', ['user_id'], ['id'])

    with op.batch_alter_table('post', schema=None) as batch_op:
        batch_op.add_column(sa.Column('blog_category_id', sa.Integer(), nullable=True))
        batch_op.add_column(sa.Column('is_featured', sa.Boolean(), nullable=True))
        batch_op.add_column(sa.Column('series_id', sa.Integer(), nullable=True))
        batch_op.add_column(sa.Column('series_order', sa.Integer(), nullable=True))
        batch_op.add_column(sa.Column('publish_at', sa.DateTime(), nullable=True))
        batch_op.add_column(sa.Column('meta_description', sa.String(length=300), nullable=True))
        batch_op.add_column(sa.Column('read_time_minutes', sa.Integer(), nullable=True))
        batch_op.create_index('idx_post_publish_at', ['publish_at'], unique=False)
        batch_op.create_foreign_key(None, 'blog_category', ['blog_category_id'], ['id'])
        batch_op.create_foreign_key(None, 'post_series', ['series_id'], ['id'])

    with op.batch_alter_table('service', schema=None) as batch_op:
        batch_op.add_column(sa.Column('duration_minutes', sa.Integer(), nullable=True))

    with op.batch_alter_table('task', schema=None) as batch_op:
        batch_op.add_column(sa.Column('retry_count', sa.Integer(), nullable=True))
        batch_op.add_column(sa.Column('max_retries', sa.Integer(), nullable=True))
        batch_op.add_column(sa.Column('next_retry_at', sa.DateTime(), nullable=True))
        batch_op.add_column(sa.Column('priority', sa.Integer(), nullable=True))
        batch_op.create_index('idx_task_next_retry', ['next_retry_at'], unique=False)
        batch_op.create_index('idx_task_status_priority', ['status', 'priority'], unique=False)

    with op.batch_alter_table('user', schema=None) as batch_op:
        batch_op.add_column(sa.Column('location_id', sa.Integer(), nullable=True))
        batch_op.add_column(sa.Column('reports_to_id', sa.Integer(), nullable=True))
        batch_op.add_column(sa.Column('job_title', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('department', sa.String(length=100), nullable=True))
        batch_op.add_column(sa.Column('profile_photo_id', sa.Integer(), nullable=True))
        batch_op.create_foreign_key(None, 'user', ['reports_to_id'], ['id'])
        batch_op.create_foreign_key(None, 'location', ['location_id'], ['id'])
        batch_op.create_foreign_key(None, 'media', ['profile_photo_id'], ['id'])

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('user', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_column('profile_photo_id')
        batch_op.drop_column('department')
        batch_op.drop_column('job_title')
        batch_op.drop_column('reports_to_id')
        batch_op.drop_column('location_id')

    with op.batch_alter_table('task', schema=None) as batch_op:
        batch_op.drop_index('idx_task_status_priority')
        batch_op.drop_index('idx_task_next_retry')
        batch_op.drop_column('priority')
        batch_op.drop_column('next_retry_at')
        batch_op.drop_column('max_retries')
        batch_op.drop_column('retry_count')

    with op.batch_alter_table('service', schema=None) as batch_op:
        batch_op.drop_column('duration_minutes')

    with op.batch_alter_table('post', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_index('idx_post_publish_at')
        batch_op.drop_column('read_time_minutes')
        batch_op.drop_column('meta_description')
        batch_op.drop_column('publish_at')
        batch_op.drop_column('series_order')
        batch_op.drop_column('series_id')
        batch_op.drop_column('is_featured')
        batch_op.drop_column('blog_category_id')

    with op.batch_alter_table('page_view', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_index(batch_op.f('ix_page_view_timestamp'))
        batch_op.drop_index(batch_op.f('ix_page_view_session_id'))
        batch_op.drop_index('idx_pageview_utm')
        batch_op.drop_index('idx_pageview_url')
        batch_op.drop_index('idx_pageview_timestamp')
        batch_op.drop_index('idx_pageview_session')
        batch_op.alter_column('user_agent',
               existing_type=sa.String(length=500),
               type_=sa.VARCHAR(length=200),
               existing_nullable=True)
        batch_op.drop_column('os')
        batch_op.drop_column('browser')
        batch_op.drop_column('device_type')
        batch_op.drop_column('utm_content')
        batch_op.drop_column('utm_term')
        batch_op.drop_column('utm_campaign')
        batch_op.drop_column('utm_medium')
        batch_op.drop_column('utm_source')
        batch_op.drop_column('load_time_ms')
        batch_op.drop_column('user_id')
        batch_op.drop_column('session_id')

    with op.batch_alter_table('page', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_index('idx_page_status')
        batch_op.drop_column('author_id')
        batch_op.drop_column('schema_type')
        batch_op.drop_column('canonical_url')
        batch_op.drop_column('status')

    with op.batch_alter_table('message', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_index('idx_message_channel_created')
        batch_op.drop_column('parent_id')

    with op.batch_alter_table('leave_request', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_index('idx_leave_user_status')
        batch_op.drop_index('idx_leave_dates')
        batch_op.drop_column('admin_notes')
        batch_op.drop_column('approved_at')
        batch_op.drop_column('approved_by_id')
        batch_op.drop_column('leave_type')

    with op.batch_alter_table('estimator', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_column('user_id')

    with op.batch_alter_table('encrypted_document', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_index('idx_doc_user_category')
        batch_op.drop_index('idx_doc_expiry')
        batch_op.drop_column('original_filename')
        batch_op.drop_column('mimetype')
        batch_op.drop_column('signed_at')
        batch_op.drop_column('signed_by_id')
        batch_op.drop_column('requires_signature')
        batch_op.drop_column('expires_at')
        batch_op.drop_column('category')

    with op.batch_alter_table('contact_form_submission', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_column('custom_fields')
        batch_op.drop_column('assigned_to_id')
        batch_op.drop_column('source')
        batch_op.drop_column('location_id')

    with op.batch_alter_table('channel', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_index('idx_channel_type')
        batch_op.drop_index('idx_channel_archived')
        batch_op.drop_column('description')
        batch_op.drop_column('created_by_id')
        batch_op.drop_column('is_direct')
        batch_op.drop_column('is_archived')

    with op.batch_alter_table('appointment', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_column('recurring_parent_id')
        batch_op.drop_column('is_recurring')
        batch_op.drop_column('checked_out_at')
        batch_op.drop_column('checked_in_at')
        batch_op.drop_column('staff_notes')
        batch_op.drop_column('location_id')

    with op.batch_alter_table('email_click_track', schema=None) as batch_op:
        batch_op.drop_index('idx_click_track_send')

    op.drop_table('email_click_track')
    op.drop_table('download_log')
    with op.batch_alter_table('wishlist', schema=None) as batch_op:
        batch_op.drop_index('idx_wishlist_user')

    op.drop_table('wishlist')
    with op.batch_alter_table('reschedule_request', schema=None) as batch_op:
        batch_op.drop_index('idx_reschedule_status')

    op.drop_table('reschedule_request')
    with op.batch_alter_table('product_image', schema=None) as batch_op:
        batch_op.drop_index('idx_product_image_primary')
        batch_op.drop_index('idx_product_image')

    op.drop_table('product_image')
    with op.batch_alter_table('message_reaction', schema=None) as batch_op:
        batch_op.drop_index('idx_reaction_message')

    op.drop_table('message_reaction')
    with op.batch_alter_table('gift_card_transaction', schema=None) as batch_op:
        batch_op.drop_index('idx_gift_card_tx')

    op.drop_table('gift_card_transaction')
    with op.batch_alter_table('email_send', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_email_send_tracking_token'))
        batch_op.drop_index('idx_email_send_token')
        batch_op.drop_index('idx_email_send_sent')
        batch_op.drop_index('idx_email_send_recipient')
        batch_op.drop_index('idx_email_send_campaign')

    op.drop_table('email_send')
    with op.batch_alter_table('download_token', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_download_token_token'))

    op.drop_table('download_token')
    with op.batch_alter_table('channel_member', schema=None) as batch_op:
        batch_op.drop_index('idx_cm_user')
        batch_op.drop_index('idx_cm_channel')

    op.drop_table('channel_member')
    with op.batch_alter_table('bundle_item', schema=None) as batch_op:
        batch_op.drop_index('idx_bundle_item')

    op.drop_table('bundle_item')
    with op.batch_alter_table('subscription', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_subscription_stripe_subscription_id'))

    op.drop_table('subscription')
    with op.batch_alter_table('sequence_enrollment', schema=None) as batch_op:
        batch_op.drop_index('idx_enrollment_status')
        batch_op.drop_index('idx_enrollment_sequence')
        batch_op.drop_index('idx_enrollment_next_step')

    op.drop_table('sequence_enrollment')
    with op.batch_alter_table('report_export', schema=None) as batch_op:
        batch_op.drop_index('idx_export_status')
        batch_op.drop_index('idx_export_created')

    op.drop_table('report_export')
    with op.batch_alter_table('related_product', schema=None) as batch_op:
        batch_op.drop_index('idx_related_product')

    op.drop_table('related_product')
    with op.batch_alter_table('recently_viewed', schema=None) as batch_op:
        batch_op.drop_index('idx_recently_viewed_user')
        batch_op.drop_index('idx_recently_viewed_session')

    op.drop_table('recently_viewed')
    with op.batch_alter_table('product_variant', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_product_variant_sku'))

    op.drop_table('product_variant')
    op.drop_table('product_attribute_assignment')
    op.drop_table('post_tags')
    with op.batch_alter_table('post_revision', schema=None) as batch_op:
        batch_op.drop_index('idx_revision_post_created')

    op.drop_table('post_revision')
    op.drop_table('post_image')
    op.drop_table('post_authors')
    with op.batch_alter_table('page_revision', schema=None) as batch_op:
        batch_op.drop_index('idx_page_revision_page_created')

    op.drop_table('page_revision')
    with op.batch_alter_table('page_custom_field', schema=None) as batch_op:
        batch_op.drop_index('idx_pcf_page')

    op.drop_table('page_custom_field')
    op.drop_table('order_item')
    op.drop_table('inventory_lock')
    with op.batch_alter_table('gift_card', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_gift_card_code'))
        batch_op.drop_index('idx_gift_card_code')
        batch_op.drop_index('idx_gift_card_active')

    op.drop_table('gift_card')
    with op.batch_alter_table('funnel_step', schema=None) as batch_op:
        batch_op.drop_index('idx_funnelstep_funnel_order')

    op.drop_table('funnel_step')
    with op.batch_alter_table('email_campaign', schema=None) as batch_op:
        batch_op.drop_index('idx_campaign_status')
        batch_op.drop_index('idx_campaign_scheduled')

    op.drop_table('email_campaign')
    with op.batch_alter_table('document_share', schema=None) as batch_op:
        batch_op.drop_index('idx_share_user')
        batch_op.drop_index('idx_share_role')
        batch_op.drop_index('idx_share_doc')

    op.drop_table('document_share')
    with op.batch_alter_table('discount_usage', schema=None) as batch_op:
        batch_op.drop_index('idx_discount_usage_user')
        batch_op.drop_index('idx_discount_usage_order')

    op.drop_table('discount_usage')
    with op.batch_alter_table('discount_rule', schema=None) as batch_op:
        batch_op.drop_index('idx_discount_rule')

    op.drop_table('discount_rule')
    with op.batch_alter_table('conversion', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_conversion_timestamp'))
        batch_op.drop_index(batch_op.f('ix_conversion_session_id'))
        batch_op.drop_index('idx_conversion_session')
        batch_op.drop_index('idx_conversion_goal_time')

    op.drop_table('conversion')
    with op.batch_alter_table('comment', schema=None) as batch_op:
        batch_op.drop_index('idx_comment_status')
        batch_op.drop_index('idx_comment_post_status')

    op.drop_table('comment')
    with op.batch_alter_table('collection_rule', schema=None) as batch_op:
        batch_op.drop_index('idx_collection_rule')

    op.drop_table('collection_rule')
    with op.batch_alter_table('collection_product', schema=None) as batch_op:
        batch_op.drop_index('idx_collection_product_pos')

    op.drop_table('collection_product')
    op.drop_table('channel_members')
    with op.batch_alter_table('availability_exception', schema=None) as batch_op:
        batch_op.drop_index('idx_exception_estimator_date')

    op.drop_table('availability_exception')
    with op.batch_alter_table('availability', schema=None) as batch_op:
        batch_op.drop_index('idx_availability_estimator_day')

    op.drop_table('availability')
    with op.batch_alter_table('audience_member', schema=None) as batch_op:
        batch_op.drop_index('idx_audience_member_audience')

    op.drop_table('audience_member')
    op.drop_table('workflow_step')
    with op.batch_alter_table('webhook', schema=None) as batch_op:
        batch_op.drop_index('idx_webhook_active')

    op.drop_table('webhook')
    with op.batch_alter_table('visitor_session', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_visitor_session_started_at'))
        batch_op.drop_index(batch_op.f('ix_visitor_session_session_token'))
        batch_op.drop_index('idx_session_utm')
        batch_op.drop_index('idx_session_user')
        batch_op.drop_index('idx_session_started')

    op.drop_table('visitor_session')
    op.drop_table('user_cart')
    with op.batch_alter_table('time_entry', schema=None) as batch_op:
        batch_op.drop_index('idx_time_user_date')

    op.drop_table('time_entry')
    op.drop_table('sms_template')
    with op.batch_alter_table('sms_consent', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_sms_consent_phone_number'))
        batch_op.drop_index('idx_sms_consent_user')
        batch_op.drop_index('idx_sms_consent_phone')

    op.drop_table('sms_consent')
    with op.batch_alter_table('shipping_rate', schema=None) as batch_op:
        batch_op.drop_index('idx_shipping_rate_zone')

    op.drop_table('shipping_rate')
    with op.batch_alter_table('saved_report', schema=None) as batch_op:
        batch_op.drop_index('idx_report_type')
        batch_op.drop_index('idx_report_created_by')

    op.drop_table('saved_report')
    with op.batch_alter_table('push_subscription', schema=None) as batch_op:
        batch_op.drop_index('idx_push_sub_user')
        batch_op.drop_index('idx_push_sub_active')

    op.drop_table('push_subscription')
    with op.batch_alter_table('product_bundle', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_product_bundle_slug'))

    op.drop_table('product_bundle')
    with op.batch_alter_table('product_attribute_value', schema=None) as batch_op:
        batch_op.drop_index('idx_attr_value_attr')

    op.drop_table('product_attribute_value')
    op.drop_table('product')
    op.drop_table('order')
    op.drop_table('notification_preference')
    with op.batch_alter_table('notification', schema=None) as batch_op:
        batch_op.drop_index('idx_notification_user_read')
        batch_op.drop_index('idx_notification_type')
        batch_op.drop_index('idx_notification_created')

    op.drop_table('notification')
    with op.batch_alter_table('leave_balance', schema=None) as batch_op:
        batch_op.drop_index('idx_balance_user_type_year')

    op.drop_table('leave_balance')
    with op.batch_alter_table('lead_note', schema=None) as batch_op:
        batch_op.drop_index('idx_lead_note_lead')
        batch_op.drop_index('idx_lead_note_created')

    op.drop_table('lead_note')
    with op.batch_alter_table('lead_activity', schema=None) as batch_op:
        batch_op.drop_index('idx_lead_activity_type')
        batch_op.drop_index('idx_lead_activity_lead')
        batch_op.drop_index('idx_lead_activity_created')

    op.drop_table('lead_activity')
    op.drop_table('funnel')
    with op.batch_alter_table('follow_up_reminder', schema=None) as batch_op:
        batch_op.drop_index('idx_followup_lead')
        batch_op.drop_index('idx_followup_due')
        batch_op.drop_index('idx_followup_assigned')

    op.drop_table('follow_up_reminder')
    with op.batch_alter_table('email_template', schema=None) as batch_op:
        batch_op.drop_index('idx_email_template_type')
        batch_op.drop_index('idx_email_template_active')

    op.drop_table('email_template')
    with op.batch_alter_table('drip_sequence', schema=None) as batch_op:
        batch_op.drop_index('idx_drip_sequence_trigger')
        batch_op.drop_index('idx_drip_sequence_active')

    op.drop_table('drip_sequence')
    with op.batch_alter_table('discount', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_discount_code'))
        batch_op.drop_index('idx_discount_code')
        batch_op.drop_index('idx_discount_automatic')
        batch_op.drop_index('idx_discount_active')

    op.drop_table('discount')
    with op.batch_alter_table('conversion_goal', schema=None) as batch_op:
        batch_op.drop_index('idx_goal_type')
        batch_op.drop_index('idx_goal_active')

    op.drop_table('conversion_goal')
    with op.batch_alter_table('collection', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_collection_slug'))
        batch_op.drop_index('idx_collection_published')
        batch_op.drop_index('idx_collection_homepage')

    op.drop_table('collection')
    op.drop_table('audit_log')
    with op.batch_alter_table('audience', schema=None) as batch_op:
        batch_op.drop_index('idx_audience_dynamic')

    op.drop_table('audience')
    op.drop_table('api_key')
    op.drop_table('workflow')
    op.drop_table('worker_heartbeat')
    op.drop_table('unsubscribed_email')
    with op.batch_alter_table('tax_rate', schema=None) as batch_op:
        batch_op.drop_index('idx_tax_rate_priority')
        batch_op.drop_index('idx_tax_rate_location')

    op.drop_table('tax_rate')
    with op.batch_alter_table('tag', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_tag_slug'))

    op.drop_table('tag')
    op.drop_table('shipping_zone')
    with op.batch_alter_table('product_attribute', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_product_attribute_slug'))
        batch_op.drop_index('idx_attr_position')

    op.drop_table('product_attribute')
    with op.batch_alter_table('post_series', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_post_series_slug'))

    op.drop_table('post_series')
    with op.batch_alter_table('pipeline_stage', schema=None) as batch_op:
        batch_op.drop_index('idx_pipeline_stage_order')

    op.drop_table('pipeline_stage')
    op.drop_table('location')
    op.drop_table('leave_type')
    op.drop_table('lead_score_rule')
    with op.batch_alter_table('lead_score', schema=None) as batch_op:
        batch_op.drop_index('idx_lead_score_value')
        batch_op.drop_index('idx_lead_score_lead')

    op.drop_table('lead_score')
    with op.batch_alter_table('email_suppression_list', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_email_suppression_list_email'))
        batch_op.drop_index('idx_suppression_reason')

    op.drop_table('email_suppression_list')
    with op.batch_alter_table('cron_task', schema=None) as batch_op:
        batch_op.drop_index('idx_cron_active_next')

    op.drop_table('cron_task')
    with op.batch_alter_table('category', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_category_slug'))

    op.drop_table('category')
    with op.batch_alter_table('blog_category', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_blog_category_slug'))

    op.drop_table('blog_category')
    # ### end Alembic commands ###
