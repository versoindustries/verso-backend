<!DOCTYPE html>
<html lang="en">

<head>
    {% if business_config.get('ga4_tracking_id') %}
    <!-- Google Analytics 4 -->
    <script async
        src="https://www.googletagmanager.com/gtag/js?id={{ business_config.get('ga4_tracking_id') }}"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', "{{ business_config.get('ga4_tracking_id') }}");
    </script>
    {% endif %}
    {# Dynamic logo URL: Use theme-uploaded logo if available, otherwise static #}
    {% if business_config.get('logo_media_id') %}
    {% set site_logo_url = url_for('media_bp.serve_media', media_id=business_config.get('logo_media_id'),
    _external=True) %}
    {% else %}
    {% set site_logo_url = url_for('static', filename='images/logo.png', _external=True) %}
    {% endif %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="{% block description %}At Verso, we're not merely developing software; we're architecting an entire ecosystem.{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:image" content="{{ site_logo_url }}">
    <meta property="og:title"
        content="{% block og_title %}{{ business_config.get('site_name', business_config.get('business_name', 'Verso Industries')) }}{% endblock %}">
    <meta property="og:description"
        content="{% block og_description %}At Verso, we're architecting sovereign software systems.{% endblock %}">
    <meta property="og:url" content="{% block og_url %}{{ request.url }}{% endblock %}">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}{{ self.og_title() }}{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}{{ self.og_description() }}{% endblock %}">
    <meta name="twitter:image" content="{{ site_logo_url }}">
    <link rel="canonical" href="{% block canonical %}{{ request.url }}{% endblock %}">
    <meta name="robots" content="{% block robots %}index, follow{% endblock %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/favicon-16x16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="192x192"
        href="{{ url_for('static', filename='images/android-chrome-192x192.png') }}">
    <link rel="icon" type="image/png" sizes="512x512"
        href="{{ url_for('static', filename='images/android-chrome-512x512.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="mask-icon" href="{{ url_for('static', filename='images/safari-pinned-tab.svg') }}" color="#5bbad5">
    <meta name="theme-color" content="#333333">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <style>
        :root {
            /* Dynamic theme variables from BusinessConfig */
            --primary-color: {{ business_config.get('primary_color', '#4169e1') }};
            --secondary-color: {{ business_config.get('secondary_color', '#6c757d') }};
            --accent-color: {{ business_config.get('accent_color', '#28a745') }};
            --font-family: {{ business_config.get('font_family', "'Neon-Regular', sans-serif") }};

            /* Override base.css aliases with dynamic values */
            --accent-blue: var(--primary-color);
            --accent-blue-dark: var(--primary-color);
            --btn-gradient: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }

        body {
            font-family: var(--font-family) !important;
        }

        /* Hide legacy flash messages as we use Toast now, or keep if useful for non-react pages */
        /* .flash-messages { display: none; } */

        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        .btn-23,
        .title-font {
            font-family: var(--font-family) !important;
        }
    </style>
    <script>
        window.versoContext = {
            user: {
                isAuthenticated: {{ current_user.is_authenticated | tojson }}{% if current_user.is_authenticated %},
                firstName: {{ current_user.first_name | tojson }},
                roles: [{% for role in current_user.roles %}"{{ role.name }}"{% if not loop.last %}, {% endif %} {% endfor %}]{% endif %}
            },
            config: {
                site_name: "{{ business_config.get('site_name', business_config.get('business_name', 'Verso Backend')) }}",
                primary_color: "{{ business_config.get('primary_color', '#4169e1') }}",
                secondary_color: "{{ business_config.get('secondary_color', '#6c757d') }}",
                accent_color: "{{ business_config.get('accent_color', '#28a745') }}",
                font_family: "{{ business_config.get('font_family', 'Neon-Regular, sans-serif') }}",
                ga4_tracking_id: "{{ business_config.get('ga4_tracking_id', '') }}"
            },
            urls: {
                index: "{{ url_for('main_routes.index') }}",
                about: "{{ url_for('main_routes.about') }}",
                services: "{{ url_for('main_routes.services') }}",
                contact: "{{ url_for('main_routes.contact') }}",
                login: "{{ url_for('auth.login') }}",
                register: "{{ url_for('auth.register') }}",
                logout: "{{ url_for('auth.logout') }}",
                blogIndex: "{{ url_for('blog.show_blog') }}",
                blogManage: "{{ url_for('blog.manage_posts') }}",
                blogNew: "{{ url_for('blog.new_post') }}",
                employeeDashboard: "{{ url_for('employee.dashboard') }}",
                messaging: "{{ url_for('messaging.index') }}",
                adminDashboard: "{{ url_for('admin.admin_dashboard') }}",
                setLanguageEn: "{{ url_for('main_routes.set_language', language='en') }}",
                setLanguageEs: "{{ url_for('main_routes.set_language', language='es') }}"
            },
            unreadNotificationsCount: {{ unread_notifications_count | default(0) }},
            featureFlags: {
                ecommerceEnabled: {{ feature_flags.ecommerce_enabled | tojson }},
                bookingEnabled: {{ feature_flags.booking_enabled | tojson }}
            },
            year: new Date().getFullYear(),
            version: "{{ current_version }}"
        };
    </script>
    <title>{% block title %}DemoSite{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/index.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fontawesome/all.min.css') }}">
    <script src="{{ url_for('static', filename='js/fullcalendar/index.global.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/calendar.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script>
        // Utility function to get the CSRF token from the cookie
        function getCsrfToken() {
            const name = 'csrf_token=';
            const decodedCookie = decodeURIComponent(document.cookie);
            const cookies = decodedCookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.indexOf(name) === 0) {
                    return cookie.substring(name.length, cookie.length);
                }
            }
            const meta = document.querySelector('meta[name="csrf-token"]');
            return meta ? meta.getAttribute('content') : null;
        }

        // Example: Set up CSRF token for AJAX requests with jQuery
        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader('X-CSRFToken', getCsrfToken());
                }
            }
        });
    </script>
    {% block additional_css %}{% endblock %}
    {% block head %}{% endblock %} <!-- Additional head content -->

    <!-- Site-wide Organization Schema -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "{{ business_config.get('site_name', business_config.get('business_name', 'Verso Industries')) }}",
      "url": "{{ request.url_root }}",
      "logo": "{{ site_logo_url }}"
    }
    </script>
    <!-- Site-wide WebSite Schema -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "{{ business_config.get('site_name', business_config.get('business_name', 'Verso Industries')) }}",
      "url": "{{ request.url_root }}"
    }
    </script>
    {% block schema %}{% endblock %}
    {{ vite_tags() }}
</head>

<body {% block body_attributes %}{% endblock %}>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div data-react-component="AlertBar"
        data-react-props='{"message": "Demo Site", "ctaText": "Contact", "ctaUrl": "{{ url_for("main_routes.contact") }}"}'>
    </div>
    <div data-react-component="Header"></div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    <div data-react-component="FlashAlerts" data-react-props='{{ {"messages": messages} | tojson }}'>
    </div>
    {% endwith %}

    <main class="container" id="main-content" role="main">
        {% block content %}
        {% block body %}{% endblock %}
        <!-- Main content will be overridden in child templates -->
        {% endblock %}
    </main>

    <div class="section-spacer"></div>

    {% if not hide_estimate_form %}
    <div data-react-component="BookingWizard"></div>
    {% endif %}

    {% block scripts %}{% endblock %}

    <div class="section-spacer"></div>

    <div data-react-component="Footer"></div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register("{{ url_for('static', filename='sw.js') }}")
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>

    <script src="{{ url_for('static', filename='js/calendar.js') }}" defer></script>

    {# Phase 24: Real User Monitoring (RUM) Script Injection #}
    {% if rum_script %}
    {{ rum_script|safe }}
    {% endif %}

</body>

</html>
