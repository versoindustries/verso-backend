{% extends "base.html" %}

{% block title %}Manage Your Posts{% endblock %}

{% block description %}View, edit, or delete your blog posts below.{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/admin-data-table.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/blog-manage-posts.css') }}">
{% endblock %}

{% block head %}
<meta name="description" content="{{ description | e }}">
<meta property="og:title" content="{{ title | e }}">
<meta property="og:description" content="{{ description | e }}">
<meta property="og:image" content="{{ url_for('static', filename='images/logo.png') }}">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ title | e }}">
<meta name="twitter:description" content="{{ description | e }}">
<meta name="twitter:image" content="{{ url_for('static', filename='images/logo.png') }}">
<link rel="canonical" href="{{ request.url }}">
<meta name="robots" content="index, follow">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "{{ title | e }}",
  "description": "{{ description | e }}"
}
</script>
{% endblock %}

{% block content %}
<div class="container py-4 blog-manage-wrapper">
  {# Breadcrumb #}
  <nav class="blog-breadcrumb">
    <a href="{{ url_for('blog.show_blog') }}">Blog</a> &gt; <span>Manage Posts</span>
  </nav>

  {# Page header #}
  <div class="blog-manage-header">
    <h1><i class="fas fa-blog"></i>Manage Your Posts</h1>
    <a href="{{ url_for('blog.new_post') }}" class="btn btn-primary">
      <i class="fas fa-plus"></i> New Post
    </a>
  </div>

  {# Flash messages #}
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% for category, message in messages %}
  <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
    {{ message | e }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endfor %}
  {% endwith %}

  {# React BlogManagement Component - KPIs and Filters #}
  <div data-react-component="BlogManagement" data-react-props='{
    "kpis": {
      "total": {{ kpis.total if kpis else 0 }},
      "published": {{ kpis.published if kpis else 0 }},
      "drafts": {{ kpis.drafts if kpis else 0 }},
      "scheduled": {{ kpis.scheduled if kpis else 0 }}
    },
    "newPostUrl": "{{ url_for('blog.new_post') }}", "csrfToken" : "{{ form.csrf_token._value() }}" }'></div>

  {# Main Content Panel #}
  <div class="blog-manage-panel">
    <div class="blog-manage-panel-header">
      <span class="blog-manage-panel-title">All Posts</span>
      <span class="text-muted" style="font-size: 0.85rem;">
        {% if posts %}{{ posts.total }} post{% if posts.total != 1 %}s{% endif %} total{% endif %}
      </span>
    </div>
    <div class="blog-manage-panel-body">
      {% if posts and posts.items %}
      <div data-react-component="AdminDataTable" data-react-props='{
                    "columns": [
                        {"accessorKey": "thumbnail", "header": "", "sortable": false, "html": true},
                        {"accessorKey": "title", "header": "Title", "html": true},
                        {% if is_admin %}{"accessorKey": "author", "header": "Author"},{% endif %}
                        {"accessorKey": "date", "header": "Date"},
                        {"accessorKey": "status", "header": "Status", "html": true},
                        {"accessorKey": "actions", "header": "Actions", "sortable": false, "html": true}
                    ],
                    "data": {{ posts_json | safe }},
                    "defaultPageSize": 25,
                    "emptyMessage": "No posts found matching your search."
                }'>
        <!-- Fallback table while React loads -->
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th></th>
                <th>Title</th>
                {% if is_admin %}<th>Author</th>{% endif %}
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for post in posts.items %}
              <tr>
                <td>
                  {% if post.image and post.image_mime_type %}
                  <img src="{{ url_for('blog.serve_image', post_id=post.id) }}" alt="{{ post.title | e }}"
                    class="img-thumbnail" style="max-width: 60px;">
                  {% else %}
                  <span class="text-muted"><i class="fas fa-image"></i></span>
                  {% endif %}
                </td>
                <td><a href="{{ url_for('blog.show_post', slug=post.slug) }}"><strong>{{ post.title | e }}</strong></a>
                </td>
                {% if is_admin %}<td>{{ post.author.username | e }}</td>{% endif %}
                <td>{{ post.created_at.strftime('%Y-%m-%d') }}</td>
                <td>
                  {% if post.is_published %}
                  <span class="badge bg-success">Published</span>
                  {% elif post.publish_at %}
                  <span class="badge bg-warning">Scheduled</span>
                  {% else %}
                  <span class="badge bg-secondary">Draft</span>
                  {% endif %}
                </td>
                <td>
                  <a href="{{ url_for('blog.show_post', slug=post.slug) }}" class="btn btn-sm btn-outline-secondary"><i
                      class="fas fa-eye"></i></a>
                  <a href="{{ url_for('blog.edit_post', post_id=post.id) }}" class="btn btn-sm btn-outline-primary"><i
                      class="fas fa-edit"></i></a>
                  <form action="{{ url_for('blog.delete_post', id=post.id) }}" method="POST"
                    class="d-inline delete-form" data-delete-post-id="{{ post.id }}">
                    {{ form.csrf_token }}
                    <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% else %}
      <div class="blog-manage-empty">
        <div class="blog-manage-empty-icon">
          <i class="fas fa-file-alt"></i>
        </div>
        <h3>No Posts Yet</h3>
        <p>Create your first blog post to share your ideas with the world.</p>
        <a href="{{ url_for('blog.new_post') }}" class="btn btn-primary">
          <i class="fas fa-plus"></i> Create Your First Post
        </a>
      </div>
      {% endif %}
    </div>
  </div>

  {# Footer links #}
  <div class="blog-manage-footer">
    <a href="{{ url_for('blog.show_blog') }}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left"></i> Back to Blog
    </a>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // Confirm delete action (for fallback table before React loads)
  document.querySelectorAll('.delete-form').forEach(form => {
    form.addEventListener('submit', (e) => {
      if (!confirm('Are you sure you want to delete this post?')) {
        e.preventDefault();
      }
    });
  });

  // Listen for filter changes from BlogManagement component
  document.addEventListener('blog-filter-change', (e) => {
    const filter = e.detail.filter;
    const table = document.querySelector('[data-react-component="AdminDataTable"]');
    if (table) {
      // Apply filter via URL parameter (page reload for server-side filtering)
      // For client-side filtering, we could filter the data directly
      console.log('Filter changed to:', filter);
    }
  });

  // Listen for search from BlogManagement component
  document.addEventListener('blog-search', (e) => {
    const query = e.detail.query;
    console.log('Search query:', query);
    // AdminDataTable has its own built-in search, this is for future enhancements
  });
</script>
{% endblock %}