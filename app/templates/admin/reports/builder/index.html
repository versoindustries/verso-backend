{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <h2><i class="fas fa-tools me-2"></i>Report Builder</h2>
    <p class="text-muted">Build custom reports by selecting type and configuration.</p>

    <div class="row">
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-cog me-2"></i>Configuration
                </div>
                <div class="card-body">
                    <form id="builderForm">
                        <div class="mb-3">
                            <label class="form-label">Report Type</label>
                            <select name="report_type" class="form-select" id="reportType">
                                {% for rt in report_types %}
                                <option value="{{ rt.value }}">{{ rt.label }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Date Range</label>
                            <select name="days" class="form-select" id="daysSelect">
                                <option value="7">Last 7 Days</option>
                                <option value="30" selected>Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="365">Last Year</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Result Limit</label>
                            <select name="limit" class="form-select" id="limitSelect">
                                <option value="10">10 items</option>
                                <option value="20">20 items</option>
                                <option value="50" selected>50 items</option>
                                <option value="100">100 items</option>
                            </select>
                        </div>

                        <button type="button" class="btn btn-primary w-100" onclick="previewReport()">
                            <i class="fas fa-eye me-2"></i>Preview Report
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-chart-bar me-2"></i>Preview</span>
                    <div id="exportButtons" style="display: none;">
                        <a href="#" class="btn btn-sm btn-outline-success" id="exportCsv">
                            <i class="fas fa-file-csv me-1"></i>CSV
                        </a>
                        <a href="#" class="btn btn-sm btn-outline-primary" id="exportXlsx">
                            <i class="fas fa-file-excel me-1"></i>Excel
                        </a>
                    </div>
                </div>
                <div class="card-body" id="previewArea">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <p>Configure your report and click Preview to see results</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a href="{{ url_for('reports.revenue') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Reports
        </a>
    </div>
</div>

<script>
    function previewReport() {
        const form = document.getElementById('builderForm');
        const formData = new FormData(form);

        document.getElementById('previewArea').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Generating report...</p>
        </div>
    `;

        fetch("{{ url_for('reports.builder_preview') }}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
            .then(response => response.json())
            .then(data => {
                const reportType = document.getElementById('reportType').value;
                const days = document.getElementById('daysSelect').value;
                let html = '';

                if (data.error) {
                    html = `<div class="alert alert-danger">${data.error}</div>`;
                } else if (reportType === 'revenue') {
                    html = `
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="p-3 border rounded">
                            <div class="text-muted small">Revenue</div>
                            <div class="fs-4 fw-bold text-success">$${data.total_revenue.toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 border rounded">
                            <div class="text-muted small">Orders</div>
                            <div class="fs-4 fw-bold">${data.order_count.toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 border rounded">
                            <div class="text-muted small">AOV</div>
                            <div class="fs-4 fw-bold">$${data.aov.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            `;
                } else if (reportType === 'products' && data.products) {
                    html = '<table class="table table-sm"><thead><tr><th>Product</th><th class="text-end">Revenue</th></tr></thead><tbody>';
                    data.products.slice(0, 10).forEach(p => {
                        html += `<tr><td>${p.product_name}</td><td class="text-end">$${p.total_revenue.toFixed(2)}</td></tr>`;
                    });
                    html += '</tbody></table>';
                } else if (reportType === 'customers' && data.customers) {
                    html = '<table class="table table-sm"><thead><tr><th>Customer</th><th class="text-end">Spent</th></tr></thead><tbody>';
                    data.customers.slice(0, 10).forEach(c => {
                        html += `<tr><td>${c.email}</td><td class="text-end">$${c.total_spent.toFixed(2)}</td></tr>`;
                    });
                    html += '</tbody></table>';
                } else if (reportType === 'traffic') {
                    html = `
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="p-3 border rounded">
                            <div class="text-muted small">Page Views</div>
                            <div class="fs-4 fw-bold">${data.page_views.toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 border rounded">
                            <div class="text-muted small">Sessions</div>
                            <div class="fs-4 fw-bold">${data.unique_sessions.toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 border rounded">
                            <div class="text-muted small">Bounce Rate</div>
                            <div class="fs-4 fw-bold">${data.bounce_rate}%</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 border rounded">
                            <div class="text-muted small">Avg Duration</div>
                            <div class="fs-4 fw-bold">${data.avg_session_duration}s</div>
                        </div>
                    </div>
                </div>
            `;
                } else if (reportType === 'tax') {
                    html = `
                <div class="row text-center">
                    <div class="col-md-6">
                        <div class="p-3 border rounded">
                            <div class="text-muted small">Total Tax</div>
                            <div class="fs-4 fw-bold text-warning">$${data.total_tax.toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 border rounded">
                            <div class="text-muted small">Orders</div>
                            <div class="fs-4 fw-bold">${data.total_orders}</div>
                        </div>
                    </div>
                </div>
            `;
                } else {
                    html = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }

                document.getElementById('previewArea').innerHTML = html;
                document.getElementById('exportButtons').style.display = 'block';

                // Update export links
                document.getElementById('exportCsv').href =
                    `{{ url_for('reports.export', report_type='PLACEHOLDER', format='csv') }}`.replace('PLACEHOLDER', reportType) + `?days=${days}`;
                document.getElementById('exportXlsx').href =
                    `{{ url_for('reports.export', report_type='PLACEHOLDER', format='xlsx') }}`.replace('PLACEHOLDER', reportType) + `?days=${days}`;
            })
            .catch(err => {
                document.getElementById('previewArea').innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
            });
    }
</script>
{% endblock %}