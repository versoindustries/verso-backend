{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-box me-2"></i>Product Performance</h2>
        <div class="d-flex gap-2">
            <select id="daysSelect" class="form-select" style="width: auto;" onchange="applyFilter()">
                <option value="7" {{ 'selected' if days==7 }}>Last 7 Days</option>
                <option value="30" {{ 'selected' if days==30 }}>Last 30 Days</option>
                <option value="90" {{ 'selected' if days==90 }}>Last 90 Days</option>
            </select>
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-download me-2"></i>Export
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item"
                            href="{{ url_for('reports.export', report_type='products', format='csv', days=days) }}"><i
                                class="fas fa-file-csv me-2"></i>CSV</a></li>
                    <li><a class="dropdown-item"
                            href="{{ url_for('reports.export', report_type='products', format='xlsx', days=days) }}"><i
                                class="fas fa-file-excel me-2"></i>Excel</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Top Products Chart -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header">
                    <i class="fas fa-chart-bar me-2"></i>Top Products by Revenue
                </div>
                <div class="card-body">
                    <canvas id="productsChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Category Breakdown -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <i class="fas fa-tags me-2"></i>Revenue by Category
                </div>
                <ul class="list-group list-group-flush">
                    {% for cat in category_revenue %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>{{ cat.name or 'Uncategorized' }}</span>
                        <span class="fw-bold">${{ "{:,.2f}".format((cat.revenue or 0) / 100) }}</span>
                    </li>
                    {% else %}
                    <li class="list-group-item text-muted">No category data</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Products Table -->
    <div class="card">
        <div class="card-header">
            <i class="fas fa-table me-2"></i>Product Performance Matrix
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="productsTable">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th class="text-end">Units Sold</th>
                        <th class="text-end">Revenue</th>
                        <th class="text-end">Orders</th>
                        <th class="text-end">Avg Order Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>
                            <a href="{{ url_for('shop_admin.edit_product', product_id=product.product_id) }}">
                                {{ product.product_name }}
                            </a>
                        </td>
                        <td class="text-end">{{ "{:,}".format(product.units_sold) }}</td>
                        <td class="text-end fw-bold">${{ "{:,.2f}".format(product.total_revenue) }}</td>
                        <td class="text-end">{{ "{:,}".format(product.order_count) }}</td>
                        <td class="text-end">${{ "{:,.2f}".format(product.avg_order_value) }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-muted text-center py-4">No product sales data for this period</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="mt-3">
        <a href="{{ url_for('reports.revenue') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Revenue
        </a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function applyFilter() {
        const days = document.getElementById('daysSelect').value;
        window.location.href = "{{ url_for('reports.products') }}?days=" + days;
    }

    document.addEventListener("DOMContentLoaded", function () {
        const products = {{ products[:10] | tojson
    }};
    const ctx = document.getElementById('productsChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: products.map(p => p.product_name.length > 20 ? p.product_name.substring(0, 20) + '...' : p.product_name),
            datasets: [{
                label: 'Revenue ($)',
                data: products.map(p => p.total_revenue),
                backgroundColor: 'rgba(78, 115, 223, 0.8)'
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: function (value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}