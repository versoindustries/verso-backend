{% extends "base.html" %}

{% block additional_css %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/list_users.css') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/components/admin-data-table.css') }}">
{% endblock %}

{% block title %}
User Management
{% endblock %}

{% block description %}
Manage user accounts, including viewing, editing, and deleting users, as well as assigning roles.
{% endblock %}

{% block head %}
<meta name="description" content="{{ description | e }}">
<meta property="og:title" content="{{ title | e }}">
<meta property="og:description" content="{{ description | e }}">
<meta property="og:image" content="{{ url_for('static', filename='images/logo.png') }}">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ title | e }}">
<meta name="twitter:description" content="{{ description | e }}">
<meta name="twitter:image" content="{{ url_for('static', filename='images/logo.png') }}">
<link rel="canonical" href="{{ request.url }}">
<meta name="robots" content="noindex, nofollow">

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "{{ title | e }}",
  "description": "{{ description | e }}"
}
</script>
{% endblock %}

{% block content %}
<section class="user-management-section">
  <div class="container">
    <header class="section-header">
      <h1 class="section-title"><i class="fas fa-users"></i> User Management</h1>
      <p class="section-subtitle">View, edit, delete, and create user accounts with assigned roles.</p>
    </header>

    <div class="action-buttons">
      <a href="{{ url_for('admin.new_user') }}" class="btn btn-primary"><i class="fas fa-user-plus"></i> Create New
        User</a>
      <a href="{{ url_for('admin.list_roles') }}" class="btn btn-secondary"><i class="fas fa-shield-alt"></i> Manage
        Roles</a>
    </div>

    {% if users %}
    <!-- Build users data for React component -->
    {% set users_data = [] %}
    {% for user in users %}
    {% set _ = users_data.append({
    'id': user.id,
    'username': user.username,
    'email': user.email,
    'roles': user.roles | map(attribute='name') | join(', '),
    'last_login': user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never',
    'edit_url': url_for('admin.edit_user', user_id=user.id),
    'delete_url': url_for('admin.delete_user', user_id=user.id)
    }) %}
    {% endfor %}

    <!-- Build bulk actions with role options -->
    {% set bulk_actions = [
    {'value': 'delete', 'label': 'Delete Selected', 'confirmMessage': 'Are you sure you want to delete {count} user(s)?
    This cannot be undone.'},
    {'value': 'deactivate', 'label': 'Deactivate Selected', 'confirmMessage': 'Deactivate {count} user(s)?'},
    {'value': 'activate', 'label': 'Activate Selected', 'confirmMessage': 'Activate {count} user(s)?'}
    ] %}
    {% for role in roles %}
    {% set _ = bulk_actions.append({'value': 'add_role_' ~ role.id, 'label': 'Add Role: ' ~ role.name}) %}
    {% endfor %}

    <!-- React AdminDataTable Component -->
    <div data-react-component="AdminDataTable" data-react-props='{
            "columns": [
                {"accessorKey": "id", "header": "ID"},
                {"accessorKey": "username", "header": "Username"},
                {"accessorKey": "email", "header": "Email"},
                {"accessorKey": "roles", "header": "Roles"},
                {"accessorKey": "last_login", "header": "Last Login"}
            ],
            "data": {{ users_data | tojson }},
            "idKey": "id",
            "bulkActions": {{ bulk_actions | tojson }},
            "bulkActionUrl": "{{ url_for(' admin.bulk_user_action') }}", "exportCsvUrl"
      : "{{ url_for('admin.export_users_csv') }}" , "defaultPageSize" : 25, "emptyMessage" : "No users found" }'>
      <!-- Fallback content while React loads -->
      <div class="table-responsive">
        <table class="user-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Email</th>
              <th>Roles</th>
              <th>Last Login</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users[:10] %}
            <tr>
              <td>{{ user.id }}</td>
              <td>{{ user.username }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.roles | map(attribute='name') | join(', ') }}</td>
              <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <p class="text-muted">Loading interactive table...</p>
      </div>
    </div>
    {% else %}
    <p class="no-users">No users found.</p>
    {% endif %}
  </div>
</section>
{% endblock %}