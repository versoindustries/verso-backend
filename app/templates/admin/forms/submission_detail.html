{% extends "admin/dashboard_base.html" %}

{% block title %}Submission #{{ submission.id }} - Admin{% endblock %}

{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="bi bi-file-text me-2"></i>Submission #{{ submission.id }}
        {% if submission.is_spam %}
        <span class="badge bg-warning">Spam ({{ submission.spam_score|round(1) }}%)</span>
        {% endif %}
    </h2>
    <div>
        <a href="{{ url_for('forms_admin.list_submissions', form_id=form.id) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Back to Submissions
        </a>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
{% for category, message in messages %}
<div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endwith %}

<div class="row">
    <!-- Main Content -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-card-list me-2"></i>Submission Data</h5>
            </div>
            <div class="card-body">
                <table class="table table-striped">
                    <tbody>
                        {% for field in field_data %}
                        <tr>
                            <th style="width: 30%;">{{ field.label }}</th>
                            <td>
                                {% if field.value is none %}
                                <span class="text-muted">‚Äî</span>
                                {% elif field.value is iterable and field.value is not string %}
                                <ul class="mb-0 ps-3">
                                    {% for item in field.value %}
                                    <li>{{ item }}</li>
                                    {% endfor %}
                                </ul>
                                {% elif field.type == 'file' %}
                                <a href="{{ url_for('static', filename='uploads/forms/' ~ form.id ~ '/' ~ field.value) }}"
                                    target="_blank">
                                    <i class="bi bi-paperclip me-1"></i>{{ field.value }}
                                </a>
                                {% elif field.type == 'email' %}
                                <a href="mailto:{{ field.value }}">{{ field.value }}</a>
                                {% elif field.type == 'phone' %}
                                <a href="tel:{{ field.value }}">{{ field.value }}</a>
                                {% else %}
                                {{ field.value }}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin Notes -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-sticky me-2"></i>Admin Notes</h5>
            </div>
            <div class="card-body">
                <form
                    action="{{ url_for('forms_admin.update_submission_notes', form_id=form.id, submission_id=submission.id) }}"
                    method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <textarea name="notes" class="form-control" rows="4"
                            placeholder="Add internal notes about this submission...">{{ submission.notes or '' }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="bi bi-save me-1"></i> Save Notes
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Status</h5>
            </div>
            <div class="card-body">
                <form
                    action="{{ url_for('forms_admin.update_submission_status', form_id=form.id, submission_id=submission.id) }}"
                    method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <select name="status" class="form-select" onchange="this.form.submit()">
                            <option value="new" {{ 'selected' if submission.status=='new' }}>üîµ New</option>
                            <option value="read" {{ 'selected' if submission.status=='read' }}>üëÅÔ∏è Read</option>
                            <option value="processed" {{ 'selected' if submission.status=='processed' }}>‚úÖ Processed
                            </option>
                            <option value="archived" {{ 'selected' if submission.status=='archived' }}>üìÅ Archived
                            </option>
                        </select>
                    </div>
                </form>
            </div>
        </div>

        <!-- Metadata -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Metadata</h5>
            </div>
            <div class="card-body">
                <dl class="mb-0">
                    <dt>Submitted</dt>
                    <dd>{{ submission.submitted_at.strftime('%Y-%m-%d %H:%M:%S UTC') if submission.submitted_at else '-'
                        }}</dd>

                    {% if submission.submitted_by %}
                    <dt>User</dt>
                    <dd>
                        <a href="{{ url_for('admin.edit_user', user_id=submission.submitted_by_id) }}">
                            {{ submission.submitted_by.username }}
                        </a>
                    </dd>
                    {% endif %}

                    <dt>IP Address</dt>
                    <dd><code>{{ submission.ip_address or 'Unknown' }}</code></dd>

                    <dt>Referrer</dt>
                    <dd>
                        {% if submission.referrer %}
                        <small><a href="{{ submission.referrer }}" target="_blank">{{ submission.referrer[:40]
                                }}...</a></small>
                        {% else %}
                        <span class="text-muted">Direct</span>
                        {% endif %}
                    </dd>

                    {% if submission.utm_params %}
                    <dt>UTM Parameters</dt>
                    <dd>
                        {% for key, value in submission.utm_params.items() %}
                        {% if value %}
                        <span class="badge bg-light text-dark me-1">{{ key }}: {{ value }}</span>
                        {% endif %}
                        {% endfor %}
                    </dd>
                    {% endif %}

                    <dt>User Agent</dt>
                    <dd><small class="text-muted">{{ submission.user_agent[:80] if submission.user_agent else 'Unknown'
                            }}...</small></dd>
                </dl>
            </div>
        </div>

        <!-- Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Actions</h5>
            </div>
            <div class="card-body d-grid gap-2">
                {% if submission.data.get('email') %}
                <a href="mailto:{{ submission.data.get('email') }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-envelope me-1"></i> Email Submitter
                </a>
                {% endif %}

                {% if submission.data.get('phone') %}
                <a href="tel:{{ submission.data.get('phone') }}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-telephone me-1"></i> Call Submitter
                </a>
                {% endif %}

                <hr>

                <form
                    action="{{ url_for('forms_admin.delete_submission', form_id=form.id, submission_id=submission.id) }}"
                    method="POST" onsubmit="return confirm('Delete this submission permanently?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                        <i class="bi bi-trash me-1"></i> Delete Submission
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}