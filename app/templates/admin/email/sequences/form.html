{% extends "base.html" %}

{% block title %}{{ action }} Drip Sequence - Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="mb-4">
        <a href="{{ url_for('email_admin.sequences') }}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left me-2"></i>Back to Sequences
        </a>
    </div>

    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">{{ action }} Drip Sequence</h4>
        </div>
        <div class="card-body">
            <form method="POST" id="sequence-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="steps_config" id="steps_config_input"
                    value='{{ sequence.steps_config|tojson if sequence and sequence.steps_config else "[]" }}'>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="name" class="form-label">Sequence Name <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" required
                                value="{{ sequence.name if sequence else '' }}" placeholder="e.g., Welcome Series">
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="2"
                                placeholder="Describe this sequence...">{{ sequence.description if sequence else '' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="trigger_event" class="form-label">Trigger Event <span
                                    class="text-danger">*</span></label>
                            <select class="form-select" id="trigger_event" name="trigger_event" required>
                                {% for event in trigger_events %}
                                <option value="{{ event.value }}" {% if sequence and sequence.trigger_event==event.value
                                    %}selected{% endif %}>
                                    {{ event.label }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">When should this sequence start?</small>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <!-- Steps Builder -->
                        <div class="card bg-light">
                            <div class="card-header d-flex justify-content-between">
                                <h6 class="mb-0">Email Steps</h6>
                                <button type="button" class="btn btn-sm btn-primary" onclick="addStep()">
                                    <i class="fas fa-plus me-1"></i>Add Step
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="steps-container">
                                    <!-- Steps will be added here -->
                                </div>
                                <div id="no-steps"
                                    class="text-center text-muted py-3 {% if sequence and sequence.steps_config %}d-none{% endif %}">
                                    <i class="fas fa-stream mb-2 d-block"></i>
                                    No steps. Click "Add Step" to build your sequence.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="d-flex justify-content-end gap-2">
                    <a href="{{ url_for('email_admin.sequences') }}" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>{{ action }} Sequence
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<template id="step-template">
    <div class="step-row mb-3 p-3 bg-white rounded border" data-order="{order}">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="badge bg-primary">Step {order}</span>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeStep(this)">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="row g-2">
            <div class="col-md-7">
                <label class="form-label small">Email Template</label>
                <select class="form-select form-select-sm step-template">
                    <option value="">Select template...</option>
                    {% for template in templates %}
                    <option value="{{ template.id }}">{{ template.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-5">
                <label class="form-label small">Delay (hours after previous)</label>
                <input type="number" class="form-control form-control-sm step-delay" value="0" min="0" placeholder="0">
            </div>
        </div>
    </div>
</template>

<script>
    let stepOrder = 1;
    const steps = JSON.parse(document.getElementById('steps_config_input').value || '[]');

    document.addEventListener('DOMContentLoaded', function () {
        // Load existing steps
        steps.sort((a, b) => a.order - b.order).forEach(step => {
            addStep(step);
        });
    });

    function addStep(existingStep) {
        const container = document.getElementById('steps-container');
        const template = document.getElementById('step-template').innerHTML;
        const html = template.replace(/{order}/g, stepOrder++);

        container.insertAdjacentHTML('beforeend', html);
        document.getElementById('no-steps').classList.add('d-none');

        // Set existing values if provided
        if (existingStep) {
            const row = container.lastElementChild;
            const templateSelect = row.querySelector('.step-template');
            const delayInput = row.querySelector('.step-delay');

            templateSelect.value = existingStep.template_id || '';
            delayInput.value = existingStep.delay_hours || 0;
        }
    }

    function removeStep(btn) {
        btn.closest('.step-row').remove();

        // Renumber remaining steps
        let order = 1;
        document.querySelectorAll('.step-row').forEach(row => {
            row.dataset.order = order;
            row.querySelector('.badge').textContent = `Step ${order}`;
            order++;
        });
        stepOrder = order;

        if (order === 1) {
            document.getElementById('no-steps').classList.remove('d-none');
        }
    }

    // Update steps config before submit
    document.getElementById('sequence-form').addEventListener('submit', function (e) {
        const steps = [];
        document.querySelectorAll('.step-row').forEach(row => {
            const template_id = parseInt(row.querySelector('.step-template').value);
            const delay_hours = parseInt(row.querySelector('.step-delay').value) || 0;
            const order = parseInt(row.dataset.order);

            if (template_id) {
                steps.push({ order, template_id, delay_hours });
            }
        });

        document.getElementById('steps_config_input').value = JSON.stringify(steps);
    });
</script>
{% endblock %}