{% extends "base.html" %}

{% block title %}{{ current_channel.get_display_name(current_user) }} - Messages{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/messaging-channel.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        {# Sidebar with channel list #}
        <div class="col-md-3">
            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="fas fa-hashtag"></i> Channels</h5>
                </div>
                <div class="list-group list-group-flush">
                    {% for c in channels %}
                    <a href="{{ url_for('messaging.channel', channel_id=c.id) }}"
                        class="list-group-item list-group-item-action {% if current_channel and c.id == current_channel.id %}active{% endif %}">
                        # {{ c.name }}
                    </a>
                    {% endfor %}
                </div>
            </div>

            {% if private_channels %}
            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="fas fa-lock"></i> Private Channels</h5>
                </div>
                <div class="list-group list-group-flush">
                    {% for c in private_channels %}
                    <a href="{{ url_for('messaging.channel', channel_id=c.id) }}"
                        class="list-group-item list-group-item-action {% if current_channel and c.id == current_channel.id %}active{% endif %}">
                        <i class="fas fa-lock"></i> {{ c.name }}
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if dm_channels %}
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-comments"></i> Direct Messages</h5>
                </div>
                <div class="list-group list-group-flush">
                    {% for c in dm_channels %}
                    <a href="{{ url_for('messaging.channel', channel_id=c.id) }}"
                        class="list-group-item list-group-item-action {% if current_channel and c.id == current_channel.id %}active{% endif %}">
                        {{ c.get_display_name(current_user) }}
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        {# Main chat area #}
        <div class="col-md-9">
            <div data-react-component="MessagingChannel" data-react-props='{
                     "channel": {{ channel_json | safe }},
                     "initialMessages": {{ messages_json | safe }},
                     "currentUserId": {{ current_user.id }},
                     "isMuted": {{ ' true' if is_muted else 'false' }}, "canManageMembers" : {{ 'true' if
                current_channel.type=='private' and (current_channel.created_by_id==current_user.id or
                current_user.has_role('admin')) else 'false' }}, "canArchive" : {{ 'true' if
                current_channel.created_by_id==current_user.id or current_user.has_role('admin') else 'false'
                }}, "seenUsers" : {{ seen_users_json | safe }}, "pollUrl"
                : "{{ url_for('messaging.poll_messages', channel_id=current_channel.id) }}" , "streamUrl"
                : "{{ url_for('messaging.stream_messages', channel_id=current_channel.id) }}" , "sendUrl"
                : "{{ url_for('messaging.send_message', channel_id=current_channel.id) }}" , "reactUrlPattern"
                : "/messaging/message/{id}/react" , "manageMembersUrl"
                : "{{ url_for('messaging.manage_members', channel_id=current_channel.id) if current_channel.type == 'private' else '' }}"
                , "toggleMuteUrl" : "{{ url_for('messaging.toggle_mute', channel_id=current_channel.id) }}"
                , "archiveUrl"
                : "{{ url_for('messaging.archive_channel', channel_id=current_channel.id) if not current_channel.is_archived else url_for('messaging.unarchive_channel', channel_id=current_channel.id) }}"
                }'>
                <!-- Loading fallback -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading messages...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading messages...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}